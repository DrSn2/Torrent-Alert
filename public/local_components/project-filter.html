<dom-module id="project-filter">
  <style>
  paper-slider {
    width: 100%;
  }
  
  paper-toggle-button {
    --paper-toggle-button-checked-bar-color: var(--paper-green-500);
    --paper-toggle-button-checked-button-color: var(--paper-green-500);
    --paper-toggle-button-checked-ink-color: var(--paper-green-500);
  }
  
  paper-toolbar {
    --paper-toolbar-background: var(--paper-teal-500);
    --paper-toolbar-color: white;
  }
  
  .body1 {
    @apply(--paper-font-body1);
  }
  
  .color {
    color: #757575;
  }
  
  .divider {
    height: 16px;
  }
  
  .form {
    margin: 8px;
    padding: 8px;
  }
  
  .footer {
    min-height: 88px;
  }
  
  .paper-slider-label {
    margin-bottom: -12px;
  }
  
  .safe {
    padding: 0;
  }
  </style>

  <template>
    <paper-header-panel mode="seamed">
      <paper-toolbar>
        <paper-icon-button icon="arrow-back" on-tap="_back"></paper-icon-button>
        <div class="title">Filter</div>
        <paper-icon-button icon="done" on-tap="_done"></paper-icon-button>
      </paper-toolbar>

      <div class="center-justified horizontal layout">
        <div class="li">
          <div class="form layout vertical">
            <div class="layout vertical">
              <div class="body1 color cursor-d">quality</div>

              <paper-radio-group selected="{{quality}}">
                <paper-radio-button name="">Good</paper-radio-button>
                <paper-radio-button name="">Very Good</paper-radio-button>
              </paper-radio-group>
            </div>

            <div class="divider"></div>

            <div class="layout vertical">
              <div class="body1 color cursor-d paper-slider-label">Torrent Age Limit</div>
              <paper-slider editable max="90" min="1" pin value="{{age}}"></paper-slider>
            </div>

            <paper-item class="safe">
              <paper-toggle-button checked="{{safe}}" class="flex">Adult Filter</paper-toggle-button>
            </paper-item>
          </div>
        </div>
      </div>

      <div class="footer"></div>
    </paper-header-panel>
  </template>
</dom-module>

<script>
(function() {
  Polymer({

    _back: function() {
      if (FlowRouter.getQueryParam('previous')) {
        FlowRouter.go(array_ascii(Base64.decode(FlowRouter.getQueryParam('previous'))));
      }
    },

    _done: function() {
      var A = this.project.query.match(/\?f=(.+) added/);

      if (A) {
        var Z = '/' + this.quality + '?f=' + A[1] + ' added:' + this.age + 'd' + (this.safe ? '&safe=1' : '');

        Meteor.call('search_project', Z, function(e, r) {
          if (!e) {
            FlowRouter.go("/torrent", {}, {
              route: null,
              project: r,
              previous: Base64.encode(ascii_array(FlowRouter.current().path)),
            });
          }
        });

        document.querySelector("#polymer_toast").toast('filtering');
      }
    },

    attached: function() {
      var _this = this;

      Tracker.autorun(function() {
        if (FlowRouter.getQueryParam('project')) {
          Meteor.subscribe('project', [FlowRouter.getQueryParam('project')]);
        }
      });

      Tracker.autorun(function() {
        if (Meteor.status().connected) {
          if (_project.findOne({
              _id: FlowRouter.getQueryParam('project'),
            })) {
            _this.project = _project.findOne({
              _id: FlowRouter.getQueryParam('project'),
            });

            _this.quality = (_this.project.query.match(/\/(.+)\?f=/) ? _this.project.query.match(/\/(.+)\?f=/)[1] : 'search');
            _this.age = (_this.project.query.match(/ added:([0-9]+)d ?/) ? +_this.project.query.match(/ added:([0-9]+)d ?/)[1] : 90);

            _this.safe = (_this.project.query.match(/&safe=(0|1)/) ? !!(+(_this.project.query.match(/&safe=(0|1)/)[1])) : false);
          }
        }
      });
    },

    is: "project-filter",

    properties: {
      age: {
        type: Number,
        value: 90,
      },
      quality: {
        type: String,
        value: 'search',
      },
      safe: {
        type: Boolean,
        value: false,
      },
    },

  });
})();
</script>
