<dom-module id="layout-trending">
  <style>
  paper-icon-item {
    border-bottom: 1px solid #EEE;
    border-top: 1px solid #EEE;
  }
  
  paper-icon-item paper-item-body {
    padding: 8px 0;
  }
  
  .color {
    color: #757575;
  }
  
  .footer {
    min-height: 88px;
  }
  
  .subhead {
    @apply(--paper-font-subhead);
  }
  
  .title,
  .title > div {
    padding: 8px;
  }
  
  .white-space-normal {
    white-space: normal;
  }
  </style>

  <template>
    <iron-localstorage name="trending" on-iron-localstorage-load-empty="_on_load_empty_trending" value="{{torrent}}"></iron-localstorage>

    <template is="dom-repeat" items="[[project]]">
      <div class="center-justified horizontal layout">
        <div class="li">
          <div class="center horizontal layout title">
            <div class="cursor-d etc flex subhead">[[item.title]]</div>

            <paper-icon-button icon="launch" on-tap="_torrent_list"></paper-icon-button>
          </div>
        </div>
      </div>

      <template filter="[[filter(item._id)]]" is="dom-repeat" items="[[torrent]]" sort="sort">
        <div class="center-justified horizontal layout">
          <div class="li">
            <paper-icon-item class="cursor-p white" on-tap="_torrent_item">
              <selectable-icon icon_class="[[return_icon_class(item.category)]]" icon_text="[[return_icon_count(item.count)]]" item-icon></selectable-icon>

              <paper-item-body two-line>
                <div secondary>[[item.category]]</div>
                <div class="white-space-normal">[[item.title]]</div>
                <div class="horizontal justified layout" secondary>
                  <div>[[item.size]] | [[item.leech]]L / [[item.seed]]S</div>
                  <div>[[return_time(item.time)]]</div>
                </div>
              </paper-item-body>
            </paper-icon-item>
          </div>
        </div>
      </template>
    </template>

    <iron-localstorage name="recent" on-iron-localstorage-load-empty="_on_load_empty_recent" value="{{recent}}"></iron-localstorage>

    <div class="center-justified horizontal layout">
      <div class="li">
        <div class="center horizontal layout title">
          <div class="cursor-d etc flex subhead">Recent Search</div>
        </div>
      </div>
    </div>

    <template is="dom-repeat" items="[[recent]]">
      <div class="center-justified horizontal layout">
        <div class="li">
          <paper-icon-item class="cursor-p white" on-tap="_torrent_list">
            <iron-icon class="color" icon="search" item-icon></iron-icon>

            <paper-item-body>
              <div>[[item.title]]</div>
            </paper-item-body>

            <div class="subhead">[[return_count(item.count)]]</div>
          </paper-icon-item>
        </div>
      </div>
    </template>

    <div class="footer"></div>
  </template>
</dom-module>

<script>
(function() {
  Polymer({

    _on_load_empty_recent: function() {
      this.recent = [];
    },

    _on_load_empty_trending: function() {
      this.trending = [];
    },

    _torrent_item: function(e) {
      FlowRouter.go("/torrent", {}, {
        torrent: e.model.__data__.item._id,
        route: 'torrent-item',
        previous: Base64.encode(ascii_array(FlowRouter.current().path)),
      });
    },

    _torrent_list: function(e) {
      if (_.map(this.project, function(item) {
          return item._id;
        }).indexOf(e.model.__data__.item._id) == -1) {
        Meteor.call("refresh_project", e.model.__data__.item._id, function(error, res) {
          if (error) {
            console.log(error);
          }
        });
      }

      FlowRouter.go("/torrent", {}, {
        previous: Base64.encode(ascii_array(FlowRouter.current().path)),
        project: e.model.__data__.item._id,
        route: null,
      });
    },

    attached: function() {
      var _this = this;

      this.project.forEach(function(project) {
        Meteor.subscribe('torrent', {
          limit: 10,
          project: [project._id],
        });
      });

      Tracker.autorun(function() {
        if (Meteor.status().connected) {
          _this.torrent = _torrent.find({
            project: {
              $in: _this.project.map(function(item) {
                return item._id;
              }),
            },
          }).fetch();
        }
      });
    },

    filter: function(project) {
      return function(torrent) {
        return (-1 < torrent.project.indexOf(project));
      };
    },

    is: "layout-trending",

    properties: {
      project: {
        type: Array,
        value: function() {
          return [{
            _id: 'latest_softwares',
            title: "App Collection",
          }];
        },
      },
    },

    return_count: function(count) {
      return number_minify(count, 1);
    },

    return_icon_class: function(text) {
      return polymer_color(text ? text : '#');
    },

    return_icon_count: function(count) {
      return (count ? count : '#');
    },

    return_time: function(time) {
      return (moment(time).isValid() ? moment(time).format('MMM DD ddd') : '#');
    },

    sort: function(A, Z) {
      return (+moment(Z.time).format('X') - +moment(A.time).format('X'));
    },

  });
})();
</script>
