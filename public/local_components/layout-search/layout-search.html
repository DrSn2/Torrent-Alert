<dom-module id="layout-search">
  <style>
  paper-icon-item {
    border-bottom: 1px solid #EEE;
    border-top: 1px solid #EEE;
  }
  
  paper-toolbar {
    --paper-toolbar-background: white;
    --paper-toolbar-color: black;
  }
  
  .body1 {
    @apply(--paper-font-body1);
  }
  
  .color {
    color: #757575;
  }
  
  .footer {
    min-height: 88px;
  }
  
  .spinner,
  .spinner > div {
    padding: 8px;
  }
  
  .subhead {
    @apply(--paper-font-subhead);
  }
  
  .title {
    padding: 8px;
  }
  </style>

  <template>
    <iron-localstorage name="search" on-iron-localstorage-load-empty="_on_load_empty_search" value="{{search}}"></iron-localstorage>

    <paper-header-panel mode="seamed">
      <paper-toolbar>
        <paper-icon-button icon="arrow-back" on-tap="_back"></paper-icon-button>
        <paper-input autocomplete autocorrect autofocus class="flex" label="Torrent Keyword Search" placeholder="#" type="search" value="{{input}}"></paper-input>
        <!-- <paper-icon-button icon="launch" on-tap="_insert_project"></paper-icon-button> -->
      </paper-toolbar>

      <div class="center-justified horizontal layout">
        <div class="li">
          <div class="horizontal layout title">
            <div class="body1 color cursor-d flex">[[return_text(search.length, searching)]]</div>
          </div>
        </div>
      </div>

      <template is="dom-repeat" items="[[search]]">
        <div class="center-justified horizontal layout">
          <div class="li">
            <paper-icon-item class="cursor-p white" on-tap="_torrent_list">
              <iron-icon class="color" icon="search" item-icon></iron-icon>

              <paper-item-body>
                <div>[[item.title]]</div>
              </paper-item-body>

              <div class="subhead">[[return_count(item.count)]]</div>
            </paper-icon-item>
          </div>
        </div>
      </template>

      <div class="center-justified horizontal layout" hidden="[[!searching]]">
        <div class="li">
          <div class="center-justified horizontal layout spinner">
            <div>
              <paper-spinner active></paper-spinner>
            </div>
          </div>
        </div>
      </div>

      <div class="footer"></div>
    </paper-header-panel>
  </template>
</dom-module>

<script>
(function() {
  Polymer({

    _back: function() {
      if (FlowRouter.getQueryParam('previous')) {
        FlowRouter.go(array_ascii(Base64.decode(FlowRouter.getQueryParam('previous'))));
      }
    },

    _input: function(newValue, oldValue) {
      this.searching = true;

      this.debounce('_input', function() {
        if (this.input) {
          var _this = this;

          Meteor.call("search_keyword_x", _this.input, function(error, response) {
            if (!error && newValue) {
              Session.set('search', JSON.stringify(response));
            }

            _this.searching = false;
          });
        } else {
          this.searching = false;
        }
      }, 1000 * 2);
    },

    _on_load_empty_search: function() {
      this.search = [];
    },

    _torrent_list: function(e) {
      FlowRouter.go("/torrent", {}, {
        previous: Base64.encode(ascii_array(FlowRouter.current().path)),
        project: e.model.__data__.item._id,
        route: null,
      });
    },

    attached: function() {
      var _this = this;

      Tracker.autorun(function() {
        Meteor.subscribe('project', Session.get('search') ? JSON.parse(Session.get('search')) : []);
      });

      Tracker.autorun(function() {
        if (Meteor.status().connected) {
          _this.search = _project.find({
            _id: {
              $in: (Session.get('search') ? JSON.parse(Session.get('search')) : []),
            },
          }).fetch();
        }
      });
    },

    is: "layout-search",

    properties: {
      input: {
        observer: '_input',
        type: String,
        value: '',
      },
      search: {
        type: Array,
        value: function() {
          return [];
        },
      },
      searching: {
        type: String,
        value: false,
      },
    },

    return_count: function(count) {
      return number_minify(count, 1);
    },

    return_text: function(search_length, searching) {
      return (searching ? 'indexing' : (search_length ? search_length + ' item' : 'noItemFound'));
    },

  });
})();
</script>
