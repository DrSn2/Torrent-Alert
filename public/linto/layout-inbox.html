<dom-module id="layout-inbox">

    <style>
    paper-drawer-panel /deep/ #drawer,
    paper-drawer-panel /deep/ #main #scrim {
        z-index: 1;
    }
    
    paper-fab {
        --paper-fab-background: var(--paper-red-500);
        --paper-fab-keyboard-focus-background: var(--paper-red-700);
    }
    
    paper-menu-button {
        padding: 0;
    }
    
    paper-toolbar {
        --paper-toolbar-background: var(--paper-cyan-700);
        --paper-toolbar-color: white;
    }
    
    paper-toolbar paper-icon-button {
        margin: 0!important;
    }
    
    paper-toolbar paper-icon-button[icon="arrow-back"] {
        transform: translateX(-42px);
    }
    
    paper-toolbar.selection paper-icon-button[icon="arrow-back"] {
        transform: translateX(0);
    }
    
    paper-toolbar.selection .selection-hidden {
        display: none;
    }
    
    paper-toolbar.selection .selection-visible {
        padding: 8px;
        transform: rotateX(0);
        visibility: visible;
        width: 40px;
    }
    
    paper-toolbar .selection-visible {
        padding: 0;
        transform: rotateX(90deg);
        transition: transform 400ms ease-in-out;
        visibility: hidden;
        width: 0;
        will-change: transform;
    }
    
    paper-toolbar .title {
        padding: 0 12px;
    }
    
    .menu-li {
        border-bottom: 2px solid #EEE;
        border-top: 2px solid #EEE;
    }
    
    .menu-b {
        bottom: 12px;
        position: fixed;
        right: 16px;
        -webkit-transition: -webkit-transform 0.2s ease-in-out;
        transition: transform 0.2s ease-in-out;
        will-change: transform;
    }
    
    .menu-b.move-down {
        transform: translate3d(0, 80px, 0)!important;
    }
    
    .primary-text {
        font-size: 16px;
        line-height: 24px;
    }
    
    .secondary-text {
        color: #757575;
        font-size: 14px;
        line-height: 20px;
    }
    
    .undo {
        display: none!important;
    }
    </style>

    <template>
        <paper-drawer-panel id="drawer">
            <paper-header-panel drawer>
                <div class="fit layout vertical">
                    <template if="[[user._id]]" is="dom-if">
                        <div class="cursor-p horizontal hover justified layout menu-li relative" style="border">
                            <div style="padding: 16px; padding-right: 8px;">
                                <selectable-icon icon_img_src$="[[user.profile.picture]]"></selectable-icon>
                            </div>

                            <div class="flex layout vertical" style="padding: 16px; padding-left: 8px;">
                                <div class="horizontal justified layout">
                                    <div class="etc flex primary-text self-center">[[user.profile.name]]</div>
                                    <div class="secondary-text self-start">12</div>
                                </div>
                                <div class="etc secondary-text">[[user.profile.email]]</div>
                            </div>

                            <paper-ripple></paper-ripple>
                        </div>
                    </template>

                    <div class="flex">
                        <iron-selector attr-for-selected="item" id="menu_opt" on-iron-select="menu_opt" selectable="menu-item" selected-attribute="selected">
                            <template is="dom-repeat" items="[[project]]">
                                <menu-item item$="[[item]]"></menu-item>
                            </template>
                        </iron-selector>
                    </div>

                    <div class="cursor-p menu-li" onclick="window.open('http://vcompile.com/torrentz')" style="padding: 16px;">About TorrentAlert</div>
                </div>
            </paper-header-panel>

            <paper-header-panel main>
                <paper-toolbar id="main_toolbar">
                    <paper-icon-button class="selection-visible" icon="arrow-back" on-click="clear_torrent_selection"></paper-icon-button>
                    <paper-icon-button class="selection-hidden" icon="menu" on-click="menuToggle"></paper-icon-button>

                    <div class="title" id="main_toolbar_title">TorrentAlert</div>

                    <paper-icon-button class="selection-visible" icon="delete" on-click="remove_torrent"></paper-icon-button>
                    <paper-icon-button class="selection-visible" icon="social:share" on-click="share"></paper-icon-button>
                    <paper-icon-button class="selection-hidden" icon="search" on-click="search_bar"></paper-icon-button>
                </paper-toolbar>

                <neon-animated-pages class="fit" id="main_page" selected="1">
                    <neon-animatable class="center-center layout vertical">
                        <div>empty</div>
                    </neon-animatable>

                    <neon-animatable>
                        <div class="center-justified horizontal layout">
                            <div class="li">
                                <iron-selector activate-event="click" attr-for-selected="item" multi selectable="inbox-item" selected-attribute="selected" selected-values="{{torrent_selected}}">
                                    <template is="dom-repeat" items="[[project]]">
                                        <template if="[[project_selected(menu_selected, item._id)]]" is="dom-if">
                                            <div class="bordered center horizontal justified layout">
                                                <div class="flex" style="padding: 16px;">[[item.keyword]]</div>

                                                <paper-icon-button class="selection-hidden" data-id$="[[item._id]]" icon="close" hidden="[[isSchedule(item.worker)]]" on-click="remove_project" style="margin-right: 8px;"></paper-icon-button>

                                                <template if="[[isSchedule(item.worker)]]" is="dom-if">
                                                    <paper-menu-button horizontal-align="right" style="margin-right: 8px;">
                                                        <paper-icon-button class="dropdown-trigger" icon="more-vert"></paper-icon-button>

                                                        <paper-menu class="dropdown-content" on-iron-select="project_opt">
                                                            <paper-item class="cursor-p" data-id$="[[item._id]]" data-opt="remove">Remove</paper-item>
                                                            <paper-item class="cursor-p" data-id$="[[item._id]]" data-opt="schedule">Schedule</paper-item>
                                                        </paper-menu>
                                                    </paper-menu-button>
                                                </template>
                                            </div>

                                            <div style="padding: 0 4px;">
                                                <paper-progress data-progress$="[[item._id]]" hidden style="width: 100%;"></paper-progress>
                                            </div>

                                            <template as="torrent" is="dom-repeat" items="[[item.torrent]]">
                                                <inbox-item item$="[[torrent]]"></inbox-item>
                                            </template>
                                        </template>
                                    </template>
                                </iron-selector>

                                <div style="min-height: 80px;"></div>
                            </div>
                        </div>
                    </neon-animatable>
                </neon-animated-pages>
            </paper-header-panel>
        </paper-drawer-panel>

        <paper-fab class="menu-b" id="fab" icon="add" on-click="add_keyword"></paper-fab>

        <paper-dialog id="remove_prompt" style="width: 320px;">
            <div>Are you sure to delete this item ?</div>

            <div class="buttons">
                <paper-button dialog-dismiss>
                    <iron-icon icon="close"></iron-icon>
                    cancel
                </paper-button>
                <paper-button on-click="remove_ok">
                    <iron-icon icon="check"></iron-icon>
                    ok
                </paper-button>
            </div>
        </paper-dialog>

        <add-keyword id="add_keyword"></add-keyword>
        <search-bar id="search_bar"></search-bar>
    </template>

    <script>
    Polymer({

        add_keyword: function() {
            this.$.add_keyword.toggle();
        },

        clear_torrent_selection: function() {
            this.torrent_selected = [];
        },

        isSchedule: function(worker) {
            return (worker == "schedule")
        },

        is: "layout-inbox",

        menuToggle: function() {
            if (this.$.drawer.narrow && $(this.$.drawer).width() <= parseInt(this.$.drawer.responsiveWidth)) {
                this.$.drawer.togglePanel();
            } else {
                this.$.drawer.forceNarrow = !this.$.drawer.forceNarrow;
            }
        },

        menu_opt: function() {
            this.$.main_toolbar.className = this.$.main_toolbar.className.replace(/ ?[a-z\-]+\-500/g, "") + " " + document.querySelector("menu-item.iron-selected selectable-icon").icon_class;

            this.menuToggle();

            this.menu_selected = document.querySelector("#menu_opt").selected._id;
        },

        observers: [
            "torrent_selected_changed(torrent_selected.splices)"
        ],

        torrent_selected_changed: function(change) {
            this.$.main_toolbar_title.textContent = (this.torrent_selected.length ? this.torrent_selected.length : "TorrentAlert");

            this.$.main_toolbar.toggleClass("grey-500", this.torrent_selected.length);
            this.$.main_toolbar.toggleClass("selection", this.torrent_selected.length);

            this.$.fab.toggleClass("move-down", this.torrent_selected.length);
        },

        project_opt: function(e, d) {
            switch (d.item.dataset.opt) {
                case "remove":
                    // remove_project
                    document.querySelector("#polymer_toast").toast("remove");
                    break;

                case "schedule":
                    document.querySelector("#polymer_toast").toast("schedule");
                    break;
            }
        },

        project_selected: function(menu_opt, project_opt) {
            return (menu_opt == "" ? true : menu_opt == project_opt);
        },

        properties: {
            menu_selected: {
                type: String,
                value: ""
            },
            torrent_selected: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            project: {
                type: Array,
                value: function() {
                    return [{
                        _id: "12345",
                        keyword: "All Type Character",
                        time: moment().format(),
                        torrent: [{
                            category: "A",
                            leech: "100",
                            seed: "100",
                            site: [],
                            size: "100MB",
                            time: moment("2014-01-01", "YYYY-MM-DD").format(),
                            title: "12345 Wha Happened YIFY like CAPITAL word come in title Linto Cheeran"
                        }, {
                            category: "A",
                            leech: "100",
                            seed: "100",
                            site: [],
                            size: "100MB",
                            time: moment("2014-01-01", "YYYY-MM-DD").format(),
                            title: "12345 Wha Happened YIFY like CAPITAL word come in title Linto Cheeran"
                        }, {
                            category: "A",
                            leech: "100",
                            seed: "100",
                            site: [],
                            size: "100MB",
                            time: moment("2014-01-01", "YYYY-MM-DD").format(),
                            title: "12345 Wha Happened YIFY like CAPITAL word come in title Linto Cheeran"
                        }],
                        worker: "search"
                    }];
                }
            },
            user: {
                type: Object,
                value: function() {
                    return {};
                }
            }
        },

        ready: function() {
            var _this = this;

            Tracker.autorun(function() {
                if (Meteor.user()) {
                    _this.user = Meteor.user();
                }
            });

            Tracker.autorun(function() {
                _this.$.main_page.selected = (_project.find().count() ? 1 : 0);
            });

            // _this.project = ; // local-store

            // _worker.find().observe({
            //     added: function() {
            //         project_progress();
            //     },

            //     removed: function(old) {
            //         project_progress();
            //     }
            // });

            _project.find().observe({
                added: function(row) {
                    var item = _.find(_this.project, function(A) {
                        return (row._id === A._id);
                    });

                    if (!item) {
                        for (var A = 0; A < row.torrent.length; A++) {
                            var item = _torrent.findOne({
                                _id: row.torrent[A]
                            });

                            row.torrent[A] = (item ? item : {
                                _id: row.torrent[A]
                            });

                            row.torrent[A].keyword = {
                                _id: row._id
                            };
                        }

                        _this.project.unshift(row);

                        _this.project = _.clone(_this.project);
                    }

                    subscribe_torrent();
                },

                changed: function(row, old) {
                    var index = _.map(_this.project, function(A) {
                        return A._id;
                    }).indexOf(row._id);

                    if (-1 < index) {
                        for (var A = 0; A < row.torrent.length; A++) {
                            var item = _torrent.findOne({
                                _id: row.torrent[A]
                            });

                            row.torrent[A] = (item ? item : {
                                _id: row.torrent[A]
                            });

                            row.torrent[A].project = {
                                _id: row._id
                            };
                        }

                        _this.project[index] = _.clone($.extend(true, _this.project[index], row));

                        _this.project[index] = _.clone(_this.project[index]);
                        _this.project = _.clone(_this.project);
                    }

                    if (old.torrent.length < row.torrent.length) {
                        subscribe_torrent();
                    }
                },

                removed: function(old) {
                    var index = _.map(_this.project, function(A) {
                        return A._id;
                    }).indexOf(old._id);

                    if (-1 < index) {
                        _this.project.splice(index, 1);

                        _this.project = _.clone(_this.project);
                    }
                }
            });

            _torrent.find().observe({
                added: function(row) {
                    for (var A = 0; A < _this.project.length; A++) {
                        var index = _.map(_this.project[A].torrent, function(item) {
                            return item._id;
                        }).indexOf(row._id);

                        if (-1 < index) {
                            _this.project[A].torrent[index] = _.clone($.extend(true, _this.project[A].torrent[index], row)); // row;

                            _this.project[A].torrent = _.clone(_this.project[A].torrent);
                            _this.project[A] = _.clone(_this.project[A]);
                            _this.project = _.clone(_this.project);
                        }
                    }
                },

                changed: function(row, old) {
                    for (var A = 0; A < _this.project.length; A++) {
                        var index = _.map(_this.project[A].torrent, function(item) {
                            return item._id;
                        }).indexOf(row._id);

                        if (-1 < index) {
                            _this.project[A].torrent[index] = _.clone($.extend(true, _this.project[A].torrent[index], row));

                            _this.project[A].torrent = _.clone(_this.project[A].torrent);
                            _this.project[A] = _.clone(_this.project[A]);
                            _this.project = _.clone(_this.project);
                        }
                    }
                },

                removed: function(old) {
                    for (var A = 0; A < _this.project.length; A++) {
                        var index = _.map(_this.project[A].torrent, function(item) {
                            return item._id;
                        }).indexOf(old._id);

                        if (-1 < index) {
                            _this.project[A].torrent.splice(index, 1);

                            _this.project[A].torrent = _.clone(_this.project[A].torrent);
                            _this.project[A] = _.clone(_this.project[A]);
                            _this.project = _.clone(_this.project);
                        }
                    }
                }
            });
        },

        // remove_ok: function(e) {
        //     var _this = this;

        //     Meteor.call("remove_project", this.$.remove_prompt.dataset.id, function(error, response) {
        //         if (error) {
        //             document.querySelector("#polymer_toast").toast(error.reason);
        //         } else {
        //             _this.$.main_toolbar.className = _this.$.main_toolbar.className.replace(/ ?[a-z\-]+\-500/g, "");

        //             _this.menu_selected = "";

        //             document.querySelector("#polymer_toast").toast(response);
        //         }
        //     });

        //     this.$.remove_prompt.close();
        // },

        // remove_torrent: function() {
        //     $("inbox-item.iron-selected").addClass("undo");

        //     var torrent = _.map(this.torrent_selected, function(A) {
        //         return A._id;
        //     });

        //     document.querySelector("#polymer_toast").undo = {
        //         project: _.map(this.torrent_selected, function(A) {
        //             return A.project._id;
        //         }),
        //         torrent: torrent
        //     };

        //     this.clear_torrent_selection();

        //     document.querySelector("#polymer_toast").toast(torrent.length + " patent removed");
        // },

        search_bar: function() {
            this.$.search_bar.toggle();
        },

        // user_opt: function() {
        //     document.querySelector("#polymer_toast").toast("userOptNotFound");

        //     this.menuToggle();
        // }

    });
    </script>

</dom-module>
