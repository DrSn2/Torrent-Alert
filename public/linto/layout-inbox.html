<dom-module id="layout-inbox">

    <style>
    paper-drawer-panel /deep/ #drawer,
    paper-drawer-panel /deep/ #main #scrim {
        z-index: 1;
    }
    
    paper-fab {
        --paper-fab-background: var(--paper-red-500);
        --paper-fab-keyboard-focus-background: var(--paper-red-700);
    }
    
    paper-menu-button {
        padding: 0;
    }
    
    paper-toolbar {
        --paper-toolbar-background: var(--paper-cyan-700);
        --paper-toolbar-color: white;
    }
    
    paper-toolbar paper-icon-button {
        margin: 0!important;
    }
    
    paper-toolbar paper-icon-button[icon="arrow-back"] {
        transform: translateX(-42px);
    }
    
    paper-toolbar.selection paper-icon-button[icon="arrow-back"] {
        transform: translateX(0);
    }
    
    paper-toolbar.selection .selection-hidden {
        display: none;
    }
    
    paper-toolbar.selection .selection-visible {
        padding: 8px;
        transform: rotateX(0);
        visibility: visible;
        width: 40px;
    }
    
    paper-toolbar .selection-visible {
        padding: 0;
        transform: rotateX(90deg);
        transition: transform 400ms ease-in-out;
        visibility: hidden;
        width: 0;
        will-change: transform;
    }
    
    paper-toolbar .title {
        padding: 0 12px;
    }
    
    .menu-li {
        border-bottom: 2px solid #EEE;
        border-top: 2px solid #EEE;
    }
    
    .menu-b {
        bottom: 12px;
        position: fixed;
        right: 16px;
        -webkit-transition: -webkit-transform 0.2s ease-in-out;
        transition: transform 0.2s ease-in-out;
        will-change: transform;
    }
    
    .menu-b.move-down {
        transform: translate3d(0, 80px, 0)!important;
    }
    
    .project_name {
        background: transparent;
        border: none;
        font-size: 16px;
        padding: 16px 8px;
    }
    
    .undo {
        display: none!important;
    }
    </style>

    <template>
        <paper-drawer-panel id="drawer">
            <paper-header-panel drawer>
                <template if="[[user._id]]" is="dom-if">
                    <paper-icon-item class="cursor-p hover menu-li relative" on-click="user_opt">
                        <div item-icon>
                            <selectable-icon icon_img_src="/img/user.png"></selectable-icon>
                        </div>

                        <paper-item-body two-line style="margin-right: 0; min-height: 0; padding: 14px 0;">
                            <div>[[user.profile.name]]</div>
                            <div secondary>[[user.profile.email]]</div>
                        </paper-item-body>

                        <paper-ripple></paper-ripple>
                    </paper-icon-item>
                </template>

                <iron-selector attr-for-selected="item" id="menu_opt" on-iron-select="menu_opt" selectable="menu-item" selected-attribute="selected">
                    <template is="dom-repeat" items="[[project]]">
                        <menu-item item$="[[item]]"></menu-item>
                    </template>
                </iron-selector>

                <paper-icon-item class="cursor-p hover menu-li relative" onclick="window.open('http://github.com/HedCET/clex', '_system')">
                    <div item-icon>
                        <selectable-icon icon_img_src="/img/github.png"></selectable-icon>
                    </div>

                    <paper-item-body two-line style="margin-right: 0; min-height: 0; padding: 14px 0;">
                        <div>open source</div>
                        <div secondary>build break develop</div>
                    </paper-item-body>

                    <paper-ripple></paper-ripple>
                </paper-icon-item>
            </paper-header-panel>

            <paper-header-panel main>
                <paper-toolbar id="main_toolbar">
                    <paper-icon-button class="selection-visible" icon="arrow-back" on-click="clear_patent_selection"></paper-icon-button>
                    <paper-icon-button class="selection-hidden" icon="menu" on-click="menuToggle"></paper-icon-button>

                    <div class="title" id="main_toolbar_title">project-store</div>

                    <paper-icon-button class="selection-visible" icon="delete" on-click="remove_patent"></paper-icon-button>
                    <paper-icon-button class="selection-visible" icon="more-vert" on-click="more_opt"></paper-icon-button>
                    <paper-icon-button class="selection-hidden" icon="search" on-click="search"></paper-icon-button>
                </paper-toolbar>

                <neon-animated-pages class="fit" id="main_page" selected="1">
                    <neon-animatable class="center-center layout vertical">
                        <div>empty</div>
                    </neon-animatable>

                    <neon-animatable>
                        <div class="center-justified horizontal layout">
                            <div class="li">
                                <iron-selector attr-for-selected="item" multi selectable="inbox-item" selected-attribute="selected" selected-values="{{patent_selected}}">
                                    <template as="project" is="dom-repeat" items="[[project]]">
                                        <template if="[[project_selected(menu_selected, project._id)]]" is="dom-if">
                                            <div class="bordered center horizontal justified layout">
                                                <input class="flex project_name" data-_id$="[[project._id]]" on-change="change_project_name" placeholder="project_name" value="{{project.name}}">

                                                <paper-menu-button horizontal-align="right" style="margin-right: 8px;">
                                                    <paper-icon-button class="dropdown-trigger" icon="cloud-queue"></paper-icon-button>
                                                    <paper-menu class="dropdown-content" on-iron-select="project_opt">
                                                        <paper-item class="cursor-p" data-_id$="[[project._id]]" data-opt="collaborate">Collaborate</paper-item>
                                                        <paper-item class="cursor-p" data-_id$="[[project._id]]" data-opt="export">Export</paper-item>
                                                        <paper-item class="cursor-p" data-_id$="[[project._id]]" data-opt="uspto_sc">SC</paper-item>
                                                        <paper-item class="cursor-p" data-_id$="[[project._id]]" data-opt="uspto_ifw">SC &amp; IFW</paper-item>
                                                        <paper-item class="cursor-p" data-_id$="[[project._id]]" data-opt="uspto_fee">Fee biblio</paper-item>
                                                        <paper-item class="cursor-p" data-_id$="[[project._id]]" data-opt="trash">Trash</paper-item>
                                                        <paper-item class="cursor-p" data-_id$="[[project._id]]" data-opt="worker">Worker</paper-item>
                                                    </paper-menu>
                                                </paper-menu-button>
                                            </div>

                                            <div style="padding: 0 4px;">
                                                <paper-progress data-project_progress$="[[project._id]]" hidden style="width: 100%;"></paper-progress>
                                            </div>

                                            <template as="patent" is="dom-repeat" items="[[project.patent]]">
                                                <inbox-item item$="[[patent]]"></inbox-item>
                                            </template>
                                        </template>
                                    </template>
                                </iron-selector>

                                <div style="min-height: 80px;"></div>
                            </div>
                        </div>
                    </neon-animatable>
                </neon-animated-pages>
            </paper-header-panel>
        </paper-drawer-panel>

        <paper-fab class="menu-b" id="fab" icon="add"></paper-fab>

        <paper-dialog id="add_prompt" style="width: 320px;">
            <div>Are you sure you want to add this item ?</div>

            <div class="buttons">
                <paper-button dialog-dismiss>
                    <iron-icon icon="close"></iron-icon>
                    cancel
                </paper-button>
                <paper-button on-click="add_ok">
                    <iron-icon icon="check"></iron-icon>
                    ok
                </paper-button>
            </div>
        </paper-dialog>

        <paper-dialog id="ifw_prompt" style="width: 320px;">
            <ul style="list-style: inside;">
                <li>Each entry separated by semi-colon</li>
                <li>Leave it empty to download whole IFW</li>
            </ul>

            <paper-textarea id="ifw_document_code" label="IFW document code" value=""></paper-textarea>

            <div class="buttons">
                <paper-button dialog-dismiss>
                    <iron-icon icon="close"></iron-icon>
                    cancel
                </paper-button>
                <paper-button on-click="ifw_ok">
                    <iron-icon icon="check"></iron-icon>
                    ok
                </paper-button>
            </div>
        </paper-dialog>

        <paper-dialog id="remove_prompt" style="width: 320px;">
            <div>Are you sure to delete this item ?</div>

            <div class="buttons">
                <paper-button dialog-dismiss>
                    <iron-icon icon="close"></iron-icon>
                    cancel
                </paper-button>
                <paper-button on-click="remove_ok">
                    <iron-icon icon="check"></iron-icon>
                    ok
                </paper-button>
            </div>
        </paper-dialog>

        <search-bar id="search_bar"></search-bar>
    </template>

    <script>
    Polymer({

        add_ok: function() {
            switch (this.$.add_prompt.dataset.opt) {
                case "uspto_fee":
                    Meteor.call("uspto_fee", this.$.add_prompt.dataset._id, function(error, response) {
                        if (error) {
                            document.querySelector("#polymer_toast").toast(error.reason);
                        } else {
                            document.querySelector("#polymer_toast").toast(response);
                        }
                    });
                    break;

                case "uspto_sc":
                    Meteor.call("uspto_sc", this.$.add_prompt.dataset._id, function(error, response) {
                        if (error) {
                            document.querySelector("#polymer_toast").toast(error.reason);
                        } else {
                            document.querySelector("#polymer_toast").toast(response);
                        }
                    });
                    break;
            }

            this.$.add_prompt.close();
        },

        change_project_name: function(e) {
            Meteor.call("change_project_name", {
                project_id: Polymer.dom(e).localTarget.dataset._id,
                project_name: Polymer.dom(e).localTarget.value
            }, function(error, response) {
                if (error) {
                    document.querySelector("#polymer_toast").toast(error.reason);
                } else {
                    document.querySelector("#polymer_toast").toast(response);
                }
            });
        },

        clear_patent_selection: function() {
            this.patent_selected = [];
        },

        ifw_ok: function() {
            Meteor.call("uspto_ifw", {
                ifw: this.$.ifw_document_code.value,
                project: this.$.ifw_prompt.dataset._id
            }, function(error, response) {
                if (error) {
                    document.querySelector("#polymer_toast").toast(error.reason);
                } else {
                    document.querySelector("#polymer_toast").toast(response);
                }
            });

            this.$.ifw_prompt.close();
        },

        is: "layout-inbox",

        menuToggle: function() {
            if (this.$.drawer.narrow && $(this.$.drawer).width() <= parseInt(this.$.drawer.responsiveWidth)) {
                this.$.drawer.togglePanel();
            } else {
                this.$.drawer.forceNarrow = !this.$.drawer.forceNarrow;
            }
        },

        menu_opt: function() {
            this.$.main_toolbar.className = this.$.main_toolbar.className.replace(/ ?[a-z\-]+\-500/g, "") + " " + document.querySelector("menu-item.iron-selected selectable-icon").icon_class;

            this.menuToggle();

            this.menu_selected = document.querySelector("#menu_opt").selected._id;
        },

        more_opt: function() {
            document.querySelector("#polymer_toast").toast("moreOptNotFound");
        },

        observers: [
            "patent_selected_changed(patent_selected.splices)"
        ],

        patent_selected_changed: function(change) {
            this.$.main_toolbar_title.textContent = (this.patent_selected.length ? this.patent_selected.length : "project-store");

            this.$.main_toolbar.toggleClass("grey-500", this.patent_selected.length);
            this.$.main_toolbar.toggleClass("selection", this.patent_selected.length);

            this.$.fab.toggleClass("move-down", this.patent_selected.length);
        },

        project_opt: function(e, d) {
            switch (d.item.dataset.opt) {
                case "collaborate":
                    document.querySelector("#polymer_toast").toast("collaborateNotFound");
                    break;

                case "export":
                    Meteor.call("export", d.item.dataset._id, function(error, response) {
                        if (error) {
                            document.querySelector("#polymer_toast").toast(error.reason);
                        } else {
                            window.open(response);
                        }
                    });

                    document.querySelector("#polymer_toast").toast("exporting to xlsx");
                    break;

                case "uspto_fee":
                    this.async(function() {
                        this.$.add_prompt.dataset._id = d.item.dataset._id;
                        this.$.add_prompt.dataset.opt = "uspto_fee";

                        this.$.add_prompt.open();
                    }, 200);
                    break;

                case "uspto_ifw":
                    this.async(function() {
                        this.$.ifw_prompt.dataset._id = d.item.dataset._id;

                        this.$.ifw_prompt.open();
                    }, 200);
                    break;

                case "uspto_sc":
                    this.async(function() {
                        this.$.add_prompt.dataset._id = d.item.dataset._id;
                        this.$.add_prompt.dataset.opt = "uspto_sc";

                        this.$.add_prompt.open();
                    }, 200);
                    break;

                case "trash":
                    this.async(function() {
                        this.$.remove_prompt.dataset._id = d.item.dataset._id;

                        this.$.remove_prompt.open();
                    }, 200);
                    break;

                case "worker":
                    document.querySelector("#polymer_toast").toast("workerNotFound");
                    break;
            }
        },

        project_selected: function(menu_opt, project_opt) {
            return (menu_opt == "" ? true : menu_opt == project_opt);
        },

        properties: {
            menu_selected: {
                type: String,
                value: ""
            },
            patent_selected: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            project: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            user: {
                type: Object,
                value: function() {
                    return {};
                }
            }
        },

        ready: function() {
            var _this = this;

            Tracker.autorun(function() {
                if (Meteor.user()) {
                    _this.user = Meteor.user();
                }
            });

            Tracker.autorun(function() {
                _this.$.main_page.selected = (_project.find().count() ? 1 : 0);
            });

            // _this.project = ; // local-store

            _worker.find().observe({
                added: function() {
                    project_progress();
                },

                removed: function(old) {
                    project_progress();
                }
            });

            _project.find().observe({
                added: function(row) {
                    var item = _.find(_this.project, function(A) {
                        return (row._id === A._id);
                    });

                    if (!item) {
                        for (var A = 0; A < row.patent.length; A++) {
                            var item = _patent.findOne({
                                _id: row.patent[A]
                            });

                            row.patent[A] = (item ? item : {
                                _id: row.patent[A]
                            });

                            row.patent[A].project = {
                                _id: row._id
                            };
                        }

                        _this.project.unshift(row);

                        _this.project = _.clone(_this.project);
                    }

                    subscribe_patent();
                },

                changed: function(row, old) {
                    var index = _.map(_this.project, function(A) {
                        return A._id;
                    }).indexOf(row._id);

                    if (-1 < index) {
                        for (var A = 0; A < row.patent.length; A++) {
                            var item = _patent.findOne({
                                _id: row.patent[A]
                            });

                            row.patent[A] = (item ? item : {
                                _id: row.patent[A]
                            });

                            row.patent[A].project = {
                                _id: row._id
                            };
                        }

                        _this.project[index] = _.clone($.extend(true, _this.project[index], row));

                        _this.project[index] = _.clone(_this.project[index]);
                        _this.project = _.clone(_this.project);
                    }

                    if (old.patent.length < row.patent.length) {
                        subscribe_patent();
                    }
                },

                removed: function(old) {
                    var index = _.map(_this.project, function(A) {
                        return A._id;
                    }).indexOf(old._id);

                    if (-1 < index) {
                        _this.project.splice(index, 1);

                        _this.project = _.clone(_this.project);
                    }
                }
            });

            _patent.find().observe({
                added: function(row) {
                    for (var A = 0; A < _this.project.length; A++) {
                        var index = _.map(_this.project[A].patent, function(item) {
                            return item._id;
                        }).indexOf(row._id);

                        if (-1 < index) {
                            _this.project[A].patent[index] = _.clone($.extend(true, _this.project[A].patent[index], row)); // row;

                            _this.project[A].patent = _.clone(_this.project[A].patent);
                            _this.project[A] = _.clone(_this.project[A]);
                            _this.project = _.clone(_this.project);
                        }
                    }
                },

                changed: function(row, old) {
                    for (var A = 0; A < _this.project.length; A++) {
                        var index = _.map(_this.project[A].patent, function(item) {
                            return item._id;
                        }).indexOf(row._id);

                        if (-1 < index) {
                            _this.project[A].patent[index] = _.clone($.extend(true, _this.project[A].patent[index], row));

                            _this.project[A].patent = _.clone(_this.project[A].patent);
                            _this.project[A] = _.clone(_this.project[A]);
                            _this.project = _.clone(_this.project);
                        }
                    }
                },

                removed: function(old) {
                    for (var A = 0; A < _this.project.length; A++) {
                        var index = _.map(_this.project[A].patent, function(item) {
                            return item._id;
                        }).indexOf(old._id);

                        if (-1 < index) {
                            _this.project[A].patent.splice(index, 1);

                            _this.project[A].patent = _.clone(_this.project[A].patent);
                            _this.project[A] = _.clone(_this.project[A]);
                            _this.project = _.clone(_this.project);
                        }
                    }
                }
            });
        },

        remove_ok: function(e) {
            var _this = this;

            Meteor.call("remove_project", this.$.remove_prompt.dataset._id, function(error, response) {
                if (error) {
                    document.querySelector("#polymer_toast").toast(error.reason);
                } else {
                    _this.$.main_toolbar.className = _this.$.main_toolbar.className.replace(/ ?[a-z\-]+\-500/g, "");

                    _this.menu_selected = "";

                    document.querySelector("#polymer_toast").toast(response);
                }
            });

            this.$.remove_prompt.close();
        },

        remove_patent: function() {
            $("inbox-item.iron-selected").addClass("undo");

            var patent = _.map(this.patent_selected, function(A) {
                return A._id;
            });

            document.querySelector("#polymer_toast").undo = {
                patent: patent,
                project: _.map(this.patent_selected, function(A) {
                    return A.project._id;
                })
            };

            this.clear_patent_selection();

            document.querySelector("#polymer_toast").toast(patent.length + " patent removed");
        },

        search: function() {
            this.$.search_bar.toggle();
        },

        user_opt: function() {
            document.querySelector("#polymer_toast").toast("userOptNotFound");

            this.menuToggle();
        }

    });
    </script>

</dom-module>
