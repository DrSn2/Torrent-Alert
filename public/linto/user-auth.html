<polymer-element attributes="section" name="user-auth">
    <template>
        <style>
        .width {
            width: {{width}}px;
        }
        
        .heading {
            background: #FFFFEE;
            border: 1px solid #ddd;
            cursor: pointer;
            padding-bottom: 10px;
            padding-top: 10px;
        }
        
        .divider {
            font-weight: bold;
            padding-bottom: 10px;
            padding-top: 10px;
        }
        
        .collapse {
            padding-bottom: 10px;
            padding-top: 10px;
            border: 1px solid #ddd;
            border-top: none;
        }
        </style>

        <div fit layout vertical style="background: white; overflow: auto;">
            <div center-center flex layout vertical>
                <paper-button class="_red width" hidden?="{{section}}" on-tap="{{googleSignInTap}}">SignIn with Google</paper-button>
                <div center-justified class="divider" hidden?="{{section}}" horizontal layout>
                    <div>OR</div>
                </div>
                <div center-justified class="heading width" hidden?="{{section}}" horizontal layout on-tap="{{signInCollapseTap}}">
                    <div>User login</div>
                </div>
                <core-collapse hidden?="{{section}}" opened?="{{signInOpened}}">
                    <div class="collapse width">
                        <div layout style="padding: 10px 15px;" vertical>
                            <paper-input label="email" value="{{signIn.email}}"></paper-input>
                            <div horizontal justified layout>
                                <div flex>
                                    <paper-input-decorator label="password">
                                        <input is="core-input" type="password" value="{{signIn.password}}">
                                    </paper-input-decorator>
                                </div>
                                <div self-end>
                                    <paper-button class="_blue" on-tap="{{signInTap}}">signIn</paper-button>
                                </div>
                            </div>
                        </div>
                    </div>
                </core-collapse>
                <div center-justified class="heading width" hidden?="{{section}}" horizontal layout on-tap="{{forgotPasswordCollapseTap}}">
                    <div>Forgot password ?</div>
                </div>
                <core-collapse hidden?="{{section}}" opened?="{{forgotPasswordOpened}}">
                    <div class="collapse width">
                        <div layout style="padding: 10px 15px;" vertical>
                            <paper-input label="email" value="{{forgotPassword.email}}"></paper-input>
                            <div horizontal justified layout>
                                <div flex></div>
                                <div self-end>
                                    <paper-button class="_red" on-tap="{{forgotPasswordTap}}">reset</paper-button>
                                </div>
                            </div>
                        </div>
                    </div>
                </core-collapse>
                <div center-justified class="divider" hidden?="{{section}}" horizontal layout>
                    <div>OR</div>
                </div>
                <div center-justified class="heading width" hidden?="{{section}}" horizontal layout on-tap="{{signUpCollapseTap}}">
                    <div>New user ? Create new Account</div>
                </div>
                <core-collapse hidden?="{{section}}" opened?="{{signUpOpened}}">
                    <div class="collapse width">
                        <div layout style="padding: 10px 15px;" vertical>
                            <paper-input label="username" value="{{signUp.username}}"></paper-input>
                            <paper-input label="email" value="{{signUp.email}}"></paper-input>
                            <div horizontal justified layout>
                                <div flex></div>
                                <div self-end>
                                    <paper-button class="_blue" on-tap="{{signUpTap}}">signUp</paper-button>
                                </div>
                            </div>
                        </div>
                    </div>
                </core-collapse>

                <div center-justified class="heading width" hidden?="{{section != 'resetPassword'}}" horizontal layout on-tap="{{resetPasswordCollapseTap}}">
                    <div>Reset Password</div>
                </div>
                <core-collapse hidden?="{{section != 'resetPassword'}}" opened?="{{resetPasswordOpened}}">
                    <div class="collapse width">
                        <div layout style="padding: 10px 15px;" vertical>
                            <paper-input-decorator label="password">
                                <input is="core-input" type="password" value="{{resetPassword.passwordA}}">
                            </paper-input-decorator>
                            <paper-input-decorator label="re-type password">
                                <input is="core-input" type="password" value="{{resetPassword.passwordZ}}">
                            </paper-input-decorator>
                            <div horizontal justified layout>
                                <div flex></div>
                                <div self-end>
                                    <paper-button class="_blue" on-tap="{{resetPasswordTap}}">save</paper-button>
                                </div>
                            </div>
                        </div>
                    </div>
                </core-collapse>

                <div center-justified class="heading width" hidden?="{{section != 'setPassword'}}" horizontal layout on-tap="{{setPasswordCollapseTap}}">
                    <div>Set Password</div>
                </div>
                <core-collapse hidden?="{{section != 'setPassword'}}" opened?="{{setPasswordOpened}}">
                    <div class="collapse width">
                        <div layout style="padding: 10px 15px;" vertical>
                            <paper-input-decorator label="password">
                                <input is="core-input" type="password" value="{{setPassword.passwordA}}">
                            </paper-input-decorator>
                            <paper-input-decorator label="re-type password">
                                <input is="core-input" type="password" value="{{setPassword.passwordZ}}">
                            </paper-input-decorator>
                            <div horizontal justified layout>
                                <div flex></div>
                                <div self-end>
                                    <paper-button class="_blue" on-tap="{{setTap}}">save</paper-button>
                                </div>
                            </div>
                        </div>
                    </div>
                </core-collapse>

                <div center-justified class="heading width" hidden?="{{section != 'changePassword'}}" horizontal layout on-tap="{{changePasswordCollapseTap}}">
                    <div>Change Password</div>
                </div>
                <core-collapse hidden?="{{section != 'changePassword'}}" opened?="{{changePasswordOpened}}">
                    <div class="collapse width">
                        <div layout style="padding: 10px 15px;" vertical>
                            <paper-input-decorator label="old password">
                                <input is="core-input" type="password" value="{{changePassword.passwordA}}">
                            </paper-input-decorator>
                            <paper-input-decorator label="password">
                                <input is="core-input" type="password" value="{{changePassword.passwordB}}">
                            </paper-input-decorator>
                            <paper-input-decorator label="re-type password">
                                <input is="core-input" type="password" value="{{changePassword.passwordC}}">
                            </paper-input-decorator>
                            <div horizontal justified layout>
                                <div flex></div>
                                <div self-end>
                                    <paper-button class="_blue" on-tap="{{changePasswordTap}}">change</paper-button>
                                </div>
                            </div>
                        </div>
                    </div>
                </core-collapse>
            </div>
        </div>

        <paper-toast duration="4000" id="toast" opened="{{toastOpened}}" swipeDisabled text="{{toastText}}"></paper-toast>
    </template>

    <script>
    Polymer("user-auth", {

        changePassword: {},
        changePasswordOpened: true,
        forgotPassword: {},
        forgotPasswordOpened: false,
        resetPassword: {},
        resetPasswordOpened: true,
        section: null,
        setPassword: {},
        setPasswordOpened: true,
        signIn: {},
        signInOpened: true,
        signUp: {},
        signUpOpened: false,
        toastOpened: false,
        toastText: "",
        width: 320,

        changePasswordTap: function(event, detail, sender) {
            console.log(this.changePassword);
        },

        changePasswordCollapseTap: function(event, detail, sender) {
            this.changePasswordOpened = !this.changePasswordOpened;
        },

        googleSignInTap: function(event, detail, sender) {
            this.toastOpened = false;

            var _this = this;

            if (Meteor.isCordova) {
                Meteor.cordova_g_plus({
                    cordova_g_plus: true,
                    profile: ["email", "email_verified", "gender", "locale", "name", "picture", "sub"]
                }, function(error) {
                    if (error) {
                        window.setTimeout(function() {
                            _this.toastText = error;
                            _this.toastOpened = true;
                        }, 400);
                    }
                });
            } else {
                if (Accounts.loginServicesConfigured()) {
                    Meteor.loginWithGoogle({
                        requestOfflineToken: true,
                        requestPermissions: ["email", "profile"]
                    }, function(error) {
                        if (error) {
                            window.setTimeout(function() {
                                _this.toastText = Accounts.LoginCancelledError.numericError;
                                _this.toastOpened = true;
                            }, 400);
                        }
                    });
                }
            }
        },

        forgotPasswordTap: function(event, detail, sender) {
            this.toastOpened = false;

            var _this = this,
                valid_email = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;

            if (valid_email.test(_this.forgotPassword.email)) {
                Accounts.forgotPassword(_.pick(_this.forgotPassword, "email"), function(error) {
                    if (error) {
                        window.setTimeout(function() {
                            _this.toastText = error;
                            _this.toastOpened = true;
                        }, 400);
                    } else {
                        window.setTimeout(function() {
                            _this.toastText = "reset password URL sent @ email";
                            _this.toastOpened = true;
                        }, 400);
                    }
                });
            } else {
                window.setTimeout(function() {
                    _this.toastText = "invalid email";
                    _this.toastOpened = true;
                }, 400);
            }
        },

        forgotPasswordCollapseTap: function(event, detail, sender) {
            this.forgotPasswordOpened = !this.forgotPasswordOpened;
            this.signInOpened = false;
            this.signUpOpened = false;
        },

        resetPasswordTap: function(event, detail, sender) {
            this.toastOpened = false;

            var _this = this;

            if (6 <= _this.resetPassword.passwordA.length) {
                if (_this.resetPassword.passwordA == _this.resetPassword.passwordZ) {
                    Accounts.resetPassword(Session.get("resetPasswordToken"), _this.resetPassword.passwordA, function(error) {
                        if (error) {
                            window.setTimeout(function() {
                                _this.toastText = error;
                                _this.toastOpened = true;
                            }, 400);
                        } else {
                            if (callback_done && (typeof callback_done == "function")) {
                                callback_done();
                            }

                            Session.set("resetPasswordToken", "_");
                        }
                    });
                } else {
                    window.setTimeout(function() {
                        _this.toastText = "password mismatch";
                        _this.toastOpened = true;
                    }, 400);
                }
            } else {
                window.setTimeout(function() {
                    _this.toastText = "min password length is 6";
                    _this.toastOpened = true;
                }, 400);
            }
        },

        resetPasswordCollapseTap: function(event, detail, sender) {
            this.resetPasswordOpened = !this.resetPasswordOpened;
        },

        setPasswordTap: function(event, detail, sender) {
            console.log(this.setPassword);
        },

        setPasswordCollapseTap: function(event, detail, sender) {
            this.setPasswordOpened = !this.setPasswordOpened;
        },

        signInTap: function(event, detail, sender) {
            this.toastOpened = false;

            var _this = this,
                valid_email = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;

            if (valid_email.test(_this.signIn.email)) {
                if (6 <= _this.signIn.password.length) {
                    Meteor.loginWithPassword(_this.signIn.email, _this.signIn.password, function(error) {
                        if (error) {
                            window.setTimeout(function() {
                                _this.toastText = error;
                                _this.toastOpened = true;
                            }, 400);
                        }
                    });
                } else {
                    window.setTimeout(function() {
                        _this.toastText = "min password length is 6";
                        _this.toastOpened = true;
                    }, 400);
                }
            } else {
                window.setTimeout(function() {
                    _this.toastText = "invalid email";
                    _this.toastOpened = true;
                }, 400);
            }
        },

        signInCollapseTap: function(event, detail, sender) {
            this.forgotPasswordOpened = false;
            this.signInOpened = !this.signInOpened;
            this.signUpOpened = false;
        },

        signUpTap: function(event, detail, sender) {
            this.toastOpened = false;

            var _this = this;

            Meteor.call("signUp", _this.signUp, function(error, res) {
                if (error) {
                    window.setTimeout(function() {
                        _this.toastText = error.reason;
                        _this.toastOpened = true;
                    }, 400);
                } else {
                    window.setTimeout(function() {
                        _this.toastText = res;
                        _this.toastOpened = true;
                    }, 400);
                }
            });
        },

        signUpCollapseTap: function(event, detail, sender) {
            this.forgotPasswordOpened = false;
            this.signInOpened = false;
            this.signUpOpened = !this.signUpOpened;
        }

    });
    </script>
</polymer-element>
