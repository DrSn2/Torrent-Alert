<polymer-element attributes="enabled list" name="search-bar">
    <template>
        <style>
        :host {
            display: none;
        }
        
        :host([enabled]) {
            display: block;
        }
        
        core-header-panel {
            background: rgba(238, 238, 238, 0.8);
            margin: 0;
            z-index: 1;
        }
        
        core-toolbar {
            background: white;
        }
        
        input {
            background: transparent;
            border: none;
            font-size: 16px;
            outline: none;
        }
        </style>

        <core-header-panel fit mode="standard">
            <core-toolbar>
                <paper-icon-button icon="arrow-back" on-tap="{{toggle}}"></paper-icon-button>
                <input flex id="searchInput" placeholder="local-store search .." value="{{searchInput}}">
                <paper-icon-button icon="filter-list" on-tap="{{filter}}"></paper-icon-button>
            </core-toolbar>
            <div center-justified horizontal layout>
                <div class="li" layout vertical>
                    <div style="padding: 10px 0;">{{list.length ? (list.length + " result" + (list.length == 1 ? "" : "s")) : status}}</div>
                    <paper-progress hidden?="{{status != 'searching ..'}}" indeterminate style="width: 100%;"></paper-progress>
                </div>
            </div>
            <template repeat="{{list}}">
                <div center-justified horizontal layout>
                    <div class="li {{list_class}}" horizontal justified layout on-tap="{{listItemTap}}" tag="{{_id}}">
                        <div class="padding-4" self-start>
                            <selectable-icon iconClass="{{category_class}}" iconText="{{linkz.length}}"></selectable-icon>
                        </div>
                        <div class="padding-4" flex layout vertical>
                            <div auto-vertical class="lowercase"><span class="title">{{title}}</span> &nbsp;<b class="description">{{category}}</b></div>
                            <div auto-vertical class="description" horizontal justified layout>
                                <div class="overflow-hidden">{{size}} | <b>{{seeds}}</b> S / <b>{{peers}}</b> P</div>
                                <div class="overflow-hidden">{{fromNow}}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
            <div horizontal layout style="padding: 42px;"></div>
        </core-header-panel>
    </template>

    <script>
    Polymer("search-bar", {

        enabled: false,
        list: [],
        searchInput: "",
        status: "",

        filter: function() {
            this.toastAlert("notFound");
        },

        listChanged: function() {
            if (!(this.list instanceof Array)) {
                this.list = JSON.parse(this.list);
            }

            // console.log(this.list);
        },

        listItemTap: function(event, detail, sender) {
            var _id = $(sender).attr("tag"),
                index = -1;

            var item = _.find(this.list, function(item) {
                index++;

                return (_id == item._id);
            });

            if (item) {
                document.querySelector("html /deep/ layout-inbox").downloadLinkz(this.list[index]);
            }
        },

        publish: {
            enabled: {
                reflect: true,
                value: false
            }
        },

        searchInputChanged: function() {
            if (document.querySelector("html /deep/ layout-inbox")) {
                this.status = "searching ..";

                var _this = this;

                _.debounce(function() {
                    _this.list = [];
                    _this.status = "notFound in local-store";

                    var searchInput = _this.searchInput.toLowerCase(),
                        searchList = document.querySelector("html /deep/ layout-inbox").getList();

                    if (searchInput.length && searchList.length) {
                        for (var A = 0; A < searchList.length; A++) {
                            $.merge(_this.list, _.filter(searchList[A].torrent_out, function(item) {
                                return (-1 < item.title.toLowerCase().search(searchInput));
                            }));
                        }
                    }
                }, 800)();
            }
        },

        toastAlert: function(alert) {
            document.querySelector("html /deep/ #layout_inbox_toast").dismiss();

            Meteor.setTimeout(function() {
                document.querySelector("html /deep/ #layout_inbox_toast").text = alert;
                document.querySelector("html /deep/ #layout_inbox_toast").show();
            }, 400);
        },

        toggle: function() {
            this.enabled = !this.enabled;

            if (this.enabled) {
                var _this = this;

                Meteor.setTimeout(function() {
                    _this.$.searchInput.focus();
                }, 400);
            }
        }

    });
    </script>
</polymer-element>
