<polymer-element attributes="loading page" name="user-check">
    <template>
        <style>
        paper-button {
            margin: 4px 0;
            width: 100%;
        }
        
        paper-input {
            width: 100%;
        }
        
        .width {
            width: 256px;
        }
        </style>

        <core-drawer-panel id="drawerPanel">
            <core-header-panel drawer style="background: white;">
                <div class="padding-4"></div>

                <div class="menu-l" horizontal justified layout on-tap="{{open_github_source}}">
                    <div class="padding-4" self-start>
                        <selectable-icon iconImgSrc="/img/github.png"></selectable-icon>
                    </div>
                    <div class="padding-4" flex layout vertical>
                        <div auto-vertical class="title">open source</div>
                        <div auto-vertical class="description">build break develop</div>
                    </div>
                </div>

                <div class="padding-4"></div>
            </core-header-panel>

            <core-header-panel id="main" main>
                <core-toolbar class="medium-tall teal-500">
                    <paper-icon-button icon="menu" on-tap="{{menuToggle}}"></paper-icon-button>
                    <div flex>Torrent Alert</div>
                    <paper-icon-button icon="more-vert" on-tap="{{more}}"></paper-icon-button>

                    <div class="bottom fit" horizontal layout>
                        <paper-tabs flex noink selected="{{page}}">
                            <paper-tab>SIGNIN</paper-tab>
                            <paper-tab hidden?="{{page != 1}}">RESET</paper-tab>
                            <paper-tab>SIGNUP</paper-tab>
                            <paper-tab hidden?="{{page != 3}}">RESENT</paper-tab>
                            <paper-tab hidden?="{{page != 4}}">SAVE</paper-tab>
                        </paper-tabs>
                    </div>
                </core-toolbar>

                <core-animated-pages fit selected="{{page}}" transitions="slide-from-right">
                    <section>
                        <div center-center fit layout vertical>
                            <div class="width" layout style="background: white; padding: 32px;" vertical>
                                <paper-button class="red-500" on-tap="{{googleSignInTap}}">SignIn with Google</paper-button>
                                <div center horizontal layout>
                                    <div flex style="border: 1px solid black;"></div>
                                    <div style="font-weight: bold; padding: 16px 8px;">OR</div>
                                    <div flex style="border: 1px solid black;"></div>
                                </div>
                                <paper-input label="email" value="{{email}}"></paper-input>
                                <paper-input-decorator label="password">
                                    <input is="core-input" type="password" value="{{password}}">
                                </paper-input-decorator>
                                <paper-button class="blue-500" on-tap="{{signInTap}}">signIn</paper-button>
                                <paper-button>
                                    <a href="#" on-tap="{{reset_password}}">reset password</a>
                                </paper-button>
                            </div>
                        </div>
                    </section>

                    <section>
                        <div center-center fit layout vertical>
                            <div class="width" layout style="background: white; padding: 32px;" vertical>
                                <paper-input label="email" value="{{email}}"></paper-input>
                                <paper-button class="blue-500" on-tap="{{resetPasswordTap}}">reset</paper-button>
                            </div>
                        </div>
                    </section>

                    <section>
                        <div center-center fit layout vertical>
                            <div class="width" layout style="background: white; padding: 32px;" vertical>
                                <paper-input label="email" value="{{email}}"></paper-input>
                                <paper-button class="blue-500" on-tap="{{signUpTap}}">signUp</paper-button>
                                <paper-button>
                                    <a href="#" on-tap="{{resent_enrollment_email}}">resent enrollment email</a>
                                </paper-button>
                            </div>
                        </div>
                    </section>

                    <section>
                        <div center-center fit layout vertical>
                            <div class="width" layout style="background: white; padding: 32px;" vertical>
                                <paper-input label="email" value="{{email}}"></paper-input>
                                <paper-button class="blue-500" on-tap="{{resentEmailTap}}">resent</paper-button>
                            </div>
                        </div>
                    </section>

                    <section>
                        <div center-center fit layout vertical>
                            <div class="width" layout style="background: white; padding: 32px;" vertical>
                                <paper-input-decorator label="password">
                                    <input is="core-input" type="password" value="{{password}}">
                                </paper-input-decorator>
                                <paper-input-decorator label="retype password">
                                    <input is="core-input" type="password" value="{{retype_password}}">
                                </paper-input-decorator>
                                <paper-button class="blue-500" on-tap="{{savePasswordTap}}">save</paper-button>
                            </div>
                        </div>
                    </section>
                </core-animated-pages>
            </core-header-panel>
        </core-drawer-panel>

        <div center-center fit hidden?="{{!loading}}" layout style="background: black; opacity: 0.4;" vertical>
            <style>
            .ball-grid-beat,
            .ball-grid-beat > div {
                -webkit-box-sizing: border-box;
                box-sizing: border-box;
                position: relative;
            }
            
            .ball-grid-beat {
                color: #fff;
                display: block;
                font-size: 0;
            }
            
            .ball-grid-beat > div {
                background-color: currentColor;
                border: 0 solid currentColor;
                display: inline-block;
                float: none;
            }
            
            .ball-grid-beat {
                height: 108px;
                width: 108px;
            }
            
            .ball-grid-beat > div {
                -webkit-animation-name: ball-grid-beat;
                animation-name: ball-grid-beat;
                -webkit-animation-iteration-count: infinite;
                animation-iteration-count: infinite;
                border-radius: 100%;
                height: 24px;
                margin: 6px;
                width: 24px;
            }
            
            .ball-grid-beat > div:nth-child(1) {
                -webkit-animation-duration: .65s;
                animation-duration: .65s;
                -webkit-animation-delay: .03s;
                animation-delay: .03s;
            }
            
            .ball-grid-beat > div:nth-child(2) {
                -webkit-animation-duration: 1.02s;
                animation-duration: 1.02s;
                -webkit-animation-delay: .09s;
                animation-delay: .09s;
            }
            
            .ball-grid-beat > div:nth-child(3) {
                -webkit-animation-duration: 1.06s;
                animation-duration: 1.06s;
                -webkit-animation-delay: -.69s;
                animation-delay: -.69s;
            }
            
            .ball-grid-beat > div:nth-child(4) {
                -webkit-animation-duration: 1.5s;
                animation-duration: 1.5s;
                -webkit-animation-delay: -.41s;
                animation-delay: -.41s;
            }
            
            .ball-grid-beat > div:nth-child(5) {
                -webkit-animation-duration: 1.6s;
                animation-duration: 1.6s;
                -webkit-animation-delay: .04s;
                animation-delay: .04s;
            }
            
            .ball-grid-beat > div:nth-child(6) {
                -webkit-animation-duration: .84s;
                animation-duration: .84s;
                -webkit-animation-delay: .07s;
                animation-delay: .07s;
            }
            
            .ball-grid-beat > div:nth-child(7) {
                -webkit-animation-duration: .68s;
                animation-duration: .68s;
                -webkit-animation-delay: -.66s;
                animation-delay: -.66s;
            }
            
            .ball-grid-beat > div:nth-child(8) {
                -webkit-animation-duration: .93s;
                animation-duration: .93s;
                -webkit-animation-delay: -.76s;
                animation-delay: -.76s;
            }
            
            .ball-grid-beat > div:nth-child(9) {
                -webkit-animation-duration: 1.24s;
                animation-duration: 1.24s;
                -webkit-animation-delay: -.76s;
                animation-delay: -.76s;
            }
            
            @-webkit-keyframes ball-grid-beat {
                0% {
                    opacity: 1;
                }
                50% {
                    opacity: .35;
                }
                100% {
                    opacity: 1;
                }
            }
            
            @keyframes ball-grid-beat {
                0% {
                    opacity: 1;
                }
                50% {
                    opacity: .35;
                }
                100% {
                    opacity: 1;
                }
            }
            </style>

            <div class="ball-grid-beat">
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
            </div>
        </div>
    </template>

    <script>
    Polymer("user-check", {

        email: "linto@vcompile.com",
        password: "password",

        domReady: function() {
            var _this = this;

            Meteor.autorun(function() {
                if (Meteor.status().connected) {
                    if (document.querySelector("html /deep/ #toast").text != "server connected") {
                        _this.toastAlert("server connected");
                    }
                } else {
                    if (document.querySelector("html /deep/ #toast").text && document.querySelector("html /deep/ #toast").text != "lost server connection") {
                        _this.toastAlert("lost server connection");
                    }
                }
            });
        },

        googleSignInTap: function(event, detail, sender) {
            var _this = this;

            if (Meteor.isCordova) {
                Meteor.cordova_g_plus({
                    cordova_g_plus: true,
                    profile: ["email", "email_verified", "gender", "locale", "name", "picture", "sub"]
                }, function(error) {
                    if (error) {
                        _this.toastAlert(error);
                    }
                });
            } else {
                if (Accounts.loginServicesConfigured()) {
                    Meteor.loginWithGoogle({
                        requestOfflineToken: true,
                        requestPermissions: ["email", "profile"]
                    }, function(error) {
                        if (error) {
                            _this.toastAlert(Accounts.LoginCancelledError.numericError);
                        }
                    });
                }
            }
        },

        menuToggle: function() {
            if (this.$.drawerPanel.narrow && $(this.$.drawerPanel).width() <= parseInt(this.$.drawerPanel.responsiveWidth)) {
                this.$.drawerPanel.togglePanel();
            } else {
                this.$.drawerPanel.forceNarrow = !this.$.drawerPanel.forceNarrow;
            }
        },

        more: function() {
            this.toastAlert("notFound");
        },

        open_github_source: function() {
            window.open("http://github.com/HedCET/TorrentAlert", "_system");
        },

        reset_password: function() {
            this.page = 1;
        },

        resetPasswordTap: function(event, detail, sender) {
            var valid_email = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;

            if (valid_email.test(this.email)) {
                var _this = this;

                Accounts.forgotPassword({
                    email: _this.email
                }, function(error) {
                    if (error) {
                        _this.toastAlert(error);
                    } else {
                        _this.toastAlert("reset password URL sent @ email");
                    }
                });
            } else {
                this.toastAlert("invalid email");
            }
        },

        resent_enrollment_email: function() {
            this.page = 3;
        },

        savePasswordTap: function(event, detail, sender) {
            if (6 <= this.password.length) {
                if (this.password == this.retype_password) {
                    var _this = this;

                    Accounts.resetPassword(Session.get("resetPasswordToken"), _this.password, function(error) {
                        if (error) {
                            _this.toastAlert(error);
                        } else {
                            if (callback_done && (typeof callback_done == "function")) {
                                callback_done();
                            }

                            Session.set("resetPasswordToken", "");
                        }
                    });
                } else {
                    this.toastAlert("password mismatch");
                }
            } else {
                this.toastAlert("min password length is 6");
            }
        },

        signInTap: function(event, detail, sender) {
            var valid_email = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;

            if (valid_email.test(this.email)) {
                if (6 <= this.password.length) {
                    var _this = this;

                    Meteor.loginWithPassword(_this.email, _this.password, function(error) {
                        if (error) {
                            _this.toastAlert(error);
                        }
                    });
                } else {
                    this.toastAlert("min password length is 6");
                }
            } else {
                this.toastAlert("invalid email");
            }
        },

        signUpTap: function(event, detail, sender) {
            var _this = this;

            Meteor.call("signUp", {
                email: _this.email
            }, function(error, res) {
                if (error) {
                    _this.toastAlert(error.reason);
                } else {
                    _this.toastAlert(res);
                }
            });
        },

        toastAlert: function(alert) {
            document.querySelector("html /deep/ #toast").dismiss();

            Meteor.setTimeout(function() {
                document.querySelector("html /deep/ #toast").text = alert;
                document.querySelector("html /deep/ #toast").show();
            }, 400);
        }

    });
    </script>
</polymer-element>
