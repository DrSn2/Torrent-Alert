<polymer-element name="download-linkz">
    <template>
        <paper-dialog backdrop opened="{{opened}}" transition="core-transition-bottom">
            <div class="padding-24" layout vertical>
                <template repeat="{{item.linkz}}">
                    <div horizontal layout on-tap="{{externalLinkTap}}" style="cursor: pointer; padding: 4px 0;" tag="{{url}}">
                        <div class="padding-4" self-start>
                            <selectable-icon iconClass="{{iconClass}}" iconText="{{iconText}}"></selectable-icon>
                        </div>
                        <div class="padding-4" flex layout vertical>
                            <div auto-vertical horizontal justified layout>
                                <div class="title overflow-hidden lowercase" flex style="width: 32px!important;">{{text}}</div>
                                <div class="badge" hidden?="{{!priority}}" self-start>{{priority}}</div>
                            </div>
                            <div auto-vertical class="description">{{fromNow}}</div>
                        </div>
                    </div>
                </template>
            </div>
        </paper-dialog>
    </template>

    <script>
    Polymer("download-linkz", {

        item: {},
        opened: false,

        externalLinkTap: function(event, detail, sender) {
            var _this = this,
                url = $(sender).attr("tag")

            Meteor.call("update_priority", {
                _id: _this.item._id,
                url: url
            }, function(error, status) {
                if (error) {
                    _this.toastAlert(error.reason);
                }
            });

            window.open(url);
        },

        open: function(item) {
            if (item.linkz && item.linkz.length) {
                this.item = item;

                for (var A = 0; A < this.item.linkz.length; A++) {
                    this.item.linkz[A].iconClass = polymer_color(this.item.linkz[A].text);
                    this.item.linkz[A].iconText = isNaN(this.item.linkz[A].text.charAt(0)) ? this.item.linkz[A].text.charAt(0) : "#";

                    this.item.linkz[A].fromNow = moment(this.item.linkz[A].time, "X").fromNow();
                }

                this.opened = true;
            } else {
                this.toastAlert("sever still processing it");
            }
        },

        toastAlert: function(alert) {
            if (document.querySelector("html /deep/ inbox-list")) {
                document.querySelector("html /deep/ inbox-list").toastOpened = false;

                Meteor.setTimeout(function() {
                    document.querySelector("html /deep/ inbox-list").toastText = alert;
                    document.querySelector("html /deep/ inbox-list").toastOpened = true;
                }, 400);
            }
        }

    });
    </script>
</polymer-element>
