<polymer-element name="download-linkz">
    <template>
        <paper-action-dialog backdrop id="downloadLinkz" transition="core-transition-bottom">
            <div class="padding-24" layout vertical>
                <template repeat="{{item.linkz}}">
                    <div horizontal layout on-tap="{{externalLinkTap}}" style="cursor: pointer; padding: 4px 0;" tag="{{url}}">
                        <div class="padding-4" self-start>
                            <selectable-icon iconClass="{{icon.class}}" iconText="{{icon.text}}"></selectable-icon>
                        </div>
                        <div class="padding-4" flex layout vertical>
                            <div auto-vertical horizontal justified layout>
                                <div class="title overflow-hidden lowercase" flex style="width: 32px!important;">{{text}}</div>
                                <div class="badge" hidden?="{{!priority}}" self-start>{{priority}}</div>
                            </div>
                            <div auto-vertical class="description">{{fromNow}}</div>
                        </div>
                    </div>
                </template>
            </div>
            <div dismissive on-tap="{{dialogToggle}}">
                <div class="paper-dialog-title" layout vertical>
                    <div auto-vertical class="description padding-4" horizontal justified layout>
                        <div class="overflow-hidden">{{item.size}}</div>
                        <div class="overflow-hidden"><b>{{item.seeds}}</b> S / <b>{{item.peers}}</b> P</div>
                    </div>
                    <div auto-vertical class="lowercase padding-4"><span class="title">{{item.title}}</span> &nbsp;<b class="description {{item.category_class}}"> {{item.category}}&nbsp;</b></div>
                </div>
            </div>
        </paper-action-dialog>
    </template>

    <script>
    Polymer("download-linkz", {

        item: {},

        dialogToggle: function() {
            this.$.downloadLinkz.close();
        },

        externalLinkTap: function(event, detail, sender) {
            var _this = this,
                url = $(sender).attr("tag")

            Meteor.call("update_priority", {
                _id: _this.item._id,
                url: url
            }, function(error, status) {
                if (error) {
                    console.log(error);
                }
            });

            window.open(url, "_system");
        },

        open: function(item) {
            if (item.linkz && item.linkz.length) {
                this.item = item;

                for (var A = 0; A < this.item.linkz.length; A++) {
                    this.item.linkz[A].icon = {
                        class: polymer_color(this.item.linkz[A].text),
                        text: (isNaN(this.item.linkz[A].text.charAt(0)) ? this.item.linkz[A].text.charAt(0) : "#")
                    };

                    this.item.linkz[A].fromNow = moment(this.item.linkz[A].time, "X").fromNow();
                }

                this.$.downloadLinkz.open();
            } else {
                this.toastAlert("under processing");
            }
        },

        toastAlert: function(alert) {
            if (document.querySelector("html /deep/ #toast")) {
                document.querySelector("html /deep/ #toast").dismiss();

                Meteor.setTimeout(function() {
                    document.querySelector("html /deep/ #toast").text = alert;
                    document.querySelector("html /deep/ #toast").show();
                }, 400);
            }
        }

    });
    </script>
</polymer-element>
