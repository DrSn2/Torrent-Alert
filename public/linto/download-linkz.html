<polymer-element name="download-linkz">
    <template>
        <paper-action-dialog backdrop id="downloadLinkz" transition="core-transition-bottom">
            <div class="padding-24" layout vertical>
                <template if="{{view == 'linkz'}}">
                    <template repeat="{{item.linkz}}">
                        <div horizontal layout on-tap="{{externalLinkTap}}" style="cursor: pointer; padding: 4px 0;" tag="{{url}}">
                            <div class="padding-4" self-start>
                                <selectable-icon iconClass="{{icon.class}}" iconText="{{icon.text}}"></selectable-icon>
                            </div>
                            <div class="padding-4" flex layout vertical>
                                <div auto-vertical horizontal justified layout>
                                    <div class="title overflow-hidden lowercase" flex style="width: 32px!important;">{{text}}</div>
                                    <div class="badge" hidden?="{{!click_count}}" self-start>{{click_count}}</div>
                                </div>
                                <div auto-vertical class="description">{{fromNow}}</div>
                            </div>
                        </div>
                    </template>
                </template>
                <template if="{{view == 'commentz'}}">
                    <paper-input-decorator hidden?="{{!connected}}" label="comment">
                        <paper-autogrow-textarea>
                            <textarea id="comment" value="{{comment}}"></textarea>
                        </paper-autogrow-textarea>
                    </paper-input-decorator>
                    <paper-button class="blue-500" hidden?="{{!connected}}" on-tap="{{postAnonymously}}">Post Anonymously</paper-button>
                    <div center horizontal layout>
                        <div flex style="border: 1px solid black;"></div>
                        <div style="padding: 16px 8px;">{{item.commentz.length ? "comment stack" : "empty comment stack"}}</div>
                        <div flex style="border: 1px solid black;"></div>
                    </div>
                    <template repeat="{{comment in item.commentz}}">
                        <div class="comment lowercase">{{comment}}</div>
                    </template>
                </template>
            </div>
            <div dismissive on-tap="{{dialogToggle}}" style="cursor: pointer; width: 100%;">
                <div class="paper-dialog-title" layout vertical>
                    <div auto-vertical class="description padding-4" horizontal justified layout>
                        <div class="overflow-hidden" flex self-end>{{item.size}} | <b>{{item.seeds}}</b> S / <b>{{item.peers}}</b> P</div>
                        <div horizontal justified layout>
                            <div class="padding-4">{{view == 'linkz' ? (item.commentz.length ? item.commentz.length : "#") : item.linkz.length}}</div>
                            <paper-icon-button icon="{{view == 'linkz' ? 'communication:comment' : 'link'}}" id="viewToggle"></paper-icon-button>
                        </div>
                    </div>
                    <div auto-vertical class="lowercase padding-4"><span class="title">{{item.title}}</span>&nbsp;&nbsp;<b class="description {{item.category_class}}">&nbsp;&nbsp;{{item.category}}&nbsp;&nbsp;</b></div>
                </div>
            </div>
        </paper-action-dialog>
    </template>

    <script>
    Polymer("download-linkz", {

        comment: "",
        connected: true,
        item: {},
        view: "linkz",

        dialogToggle: function(event, detail, sender) {
            if (event.target == this.$.viewToggle) {
                if (this.view == "linkz") this.view = "commentz";
                else this.view = "linkz";
            } else {
                this.$.downloadLinkz.close();
            }
        },

        externalLinkTap: function(event, detail, sender) {
            var _this = this,
                url = $(sender).attr("tag")

            if (Meteor.status().connected) {
                Meteor.call("update_click_count", {
                    _id: _this.item._id,
                    url: url
                }, function(error, status) {
                    if (error) {
                        console.log(error);
                    }
                });
            }

            window.open(url, "_system");
        },

        open: function(item) {
            if (item.linkz && item.linkz.length) {
                this.comment = "";
                this.connected = Meteor.status().connected;
                this.item = item;
                this.view = "linkz";

                for (var A = 0; A < this.item.linkz.length; A++) {
                    this.item.linkz[A].icon = {
                        class: polymer_color(this.item.linkz[A].text),
                        text: (isNaN(this.item.linkz[A].text.charAt(0)) ? this.item.linkz[A].text.charAt(0) : "#")
                    };

                    this.item.linkz[A].fromNow = moment(this.item.linkz[A].time, "X").fromNow();
                }

                this.$.downloadLinkz.open();
            } else {
                this.toastAlert("under processing");
            }
        },

        postAnonymously: function() {
            var A = this.comment.replace(/\s+/g, " ").trim();

            if (Meteor.status().connected && A.length) {
                var _this = this;

                Meteor.call("insert_comment", {
                    _id: _this.item._id,
                    comment: A
                }, function(error, status) {
                    if (error) {
                        console.log(error);
                    }
                });
            }

            this.comment = "";
        },

        toastAlert: function(alert) {
            if (document.querySelector("html /deep/ #toast")) {
                document.querySelector("html /deep/ #toast").dismiss();

                Meteor.setTimeout(function() {
                    document.querySelector("html /deep/ #toast").text = alert;
                    document.querySelector("html /deep/ #toast").show();
                }, 400);
            }
        }

    });
    </script>
</polymer-element>
