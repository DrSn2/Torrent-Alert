<dom-module id="layout-inbox">

    <style>
    paper-drawer-panel /deep/ #drawer,
    paper-drawer-panel /deep/ #main #scrim {
        z-index: 1;
    }
    
    paper-fab {
        --paper-fab-background: var(--paper-red-500);
        --paper-fab-keyboard-focus-background: var(--paper-red-700);
    }
    
    paper-menu-button {
        padding: 0;
    }
    
    paper-toggle-button {
        --paper-toggle-button-checked-bar-color: var(--paper-green-500);
        --paper-toggle-button-checked-button-color: var(--paper-green-500);
        --paper-toggle-button-checked-ink-color: var(--paper-green-500);
    }
    
    paper-toolbar {
        --paper-toolbar-background: var(--paper-cyan-700);
        --paper-toolbar-color: white;
    }
    
    paper-toolbar paper-icon-button {
        margin: 0!important;
    }
    
    paper-toolbar paper-icon-button[icon="arrow-back"] {
        transform: translateX(-42px);
    }
    
    paper-toolbar.selection paper-icon-button[icon="arrow-back"] {
        transform: translateX(0);
    }
    
    paper-toolbar.selection .selection-hidden {
        display: none;
    }
    
    paper-toolbar.selection .selection-visible {
        padding: 8px;
        transform: rotateX(0);
        visibility: visible;
        width: 40px;
    }
    
    paper-toolbar .selection-visible {
        padding: 0;
        transform: rotateX(90deg);
        transition: transform 400ms ease-in-out;
        visibility: hidden;
        width: 0;
        will-change: transform;
    }
    
    paper-toolbar .title {
        padding: 0 12px;
    }
    
    .menu-li {
        border-bottom: 2px solid #EEE;
        border-top: 2px solid #EEE;
    }
    
    .menu-b {
        bottom: 12px;
        position: fixed;
        right: 16px;
        -webkit-transition: -webkit-transform 0.2s ease-in-out;
        transition: transform 0.2s ease-in-out;
        will-change: transform;
    }
    
    .menu-b.move-down {
        transform: translate3d(0, 80px, 0)!important;
    }
    
    .undo {
        display: none!important;
    }
    </style>

    <template>
        <iron-localstorage name="proxy" on-iron-localstorage-load-empty="initialize_proxy" value="{{proxy}}"></iron-localstorage>

        <paper-drawer-panel id="drawer">
            <paper-header-panel drawer>
                <div class="fit layout vertical">
                    <template if="[[user._id]]" is="dom-if">
                        <div class="cursor-p horizontal hover justified layout menu-li relative" on-click="user_prompt" style="border">
                            <div style="padding: 16px; padding-right: 8px;">
                                <selectable-icon icon_img_src$="[[user.profile.picture]]"></selectable-icon>
                            </div>

                            <div class="flex layout vertical" style="padding: 16px; padding-left: 8px;">
                                <div class="horizontal justified layout">
                                    <div class="etc flex self-center" style="font-size: 16px; line-height: 24px;">[[user.profile.name]]</div>
                                    <div class="self-start" style="color: #757575; font-size: 14px; line-height: 20px;">[[return_text(project.length)]]</div>
                                </div>
                                <div class="etc" style="color: #757575; font-size: 14px; line-height: 20px;">[[user.profile.email]]</div>
                            </div>

                            <paper-ripple></paper-ripple>
                        </div>
                    </template>

                    <div class="flex" style="overflow: auto;">
                        <iron-selector activate-event="click" id="menu_opt" on-iron-select="menu_opt" selected-attribute="selected">
                            <template is="dom-repeat" items="[[project]]">
                                <div class="cursor-p horizontal hover justified layout menu-li relative" data-id$="[[item._id]]">
                                    <div style="padding: 16px; padding-right: 8px;">
                                        <selectable-icon icon_class$="[[return_class(item.keyword)]]" icon_text$="[[return_icon_text(item.keyword)]]"></selectable-icon>
                                    </div>

                                    <div class="flex layout vertical" style="padding: 16px; padding-left: 8px;">
                                        <div class="horizontal justified layout">
                                            <div class="etc flex self-center" style="font-size: 16px; line-height: 24px;">[[item.keyword]]</div>
                                            <div class="self-start" style="color: #757575; font-size: 14px; line-height: 20px;">[[return_torrent_count(item.torrent)]]</div>
                                        </div>
                                        <div class="etc" style="color: #757575; font-size: 14px; line-height: 20px;">[[return_project_description(item)]]</div>
                                    </div>

                                    <paper-ripple></paper-ripple>
                                </div>
                            </template>
                        </iron-selector>
                    </div>

                    <div class="cursor-p menu-li white" onclick="window.open('http://vcompile.com/torrentz', '_system')" style="padding: 16px; z-index: 1;">About TorrentAlert</div>
                </div>
            </paper-header-panel>

            <paper-header-panel main>
                <paper-toolbar id="main_toolbar">
                    <paper-icon-button class="selection-visible" icon="arrow-back" on-click="clear_torrent_selection"></paper-icon-button>
                    <paper-icon-button class="selection-hidden" icon="menu" on-click="menuToggle"></paper-icon-button>

                    <div class="title" id="main_toolbar_title">TorrentAlert</div>

                    <paper-icon-button class="selection-visible" icon="delete" on-click="remove_torrent"></paper-icon-button>
                    <paper-icon-button class="selection-visible" icon="social:share" on-click="share"></paper-icon-button>
                    <paper-icon-button class="selection-hidden" icon="search" on-click="search_bar"></paper-icon-button>
                </paper-toolbar>

                <neon-animated-pages class="fit" id="main_page" selected="1">
                    <neon-animatable class="center-center layout vertical">
                        <div>empty</div>
                    </neon-animatable>

                    <neon-animatable>
                        <div class="center-justified horizontal layout">
                            <div class="li">
                                <iron-selector activate-event="click" attr-for-selected="item" multi selectable="inbox-item" selected-attribute="selected" selected-values="{{torrent_selected}}">
                                    <template is="dom-repeat" items="[[project]]">
                                        <template if="[[project_selected(menu_selected, item._id)]]" is="dom-if">
                                            <div class="bordered center horizontal justified layout">
                                                <div class="flex" style="padding: 16px;">[[item.keyword]]</div>

                                                <paper-icon-button data-index$="[[index]]" icon="sort" on-click="sort"></paper-icon-button>

                                                <paper-icon-button data-id$="[[item._id]]" icon="schedule" hidden="[[!is_search(item.worker)]]" on-click="schedule"></paper-icon-button>

                                                <paper-icon-button data-id$="[[item._id]]" icon="refresh" on-click="refresh"></paper-icon-button>

                                                <paper-icon-button data-id$="[[item._id]]" icon="close" on-click="remove_project" style="margin-right: 8px;"></paper-icon-button>
                                            </div>

                                            <div style="padding: 0 4px;">
                                                <paper-progress class="project_progress" data-id$="[[item._id]]" hidden style="width: 100%;"></paper-progress>
                                            </div>

                                            <template as="torrent" is="dom-repeat" items="[[item.torrent]]">
                                                <template if="[[torrent.url]]" is="dom-if">
                                                    <inbox-item item$="[[torrent]]"></inbox-item>
                                                </template>
                                            </template>
                                        </template>
                                    </template>
                                </iron-selector>

                                <div style="min-height: 80px;"></div>
                            </div>
                        </div>
                    </neon-animatable>
                </neon-animated-pages>
            </paper-header-panel>
        </paper-drawer-panel>

        <paper-fab class="menu-b" id="fab" icon="add" on-click="add_project"></paper-fab>

        <paper-dialog id="user_prompt" on-iron-overlay-closed="prompt_closed" style="width: 320px;" with-backdrop>
            <div class="layout vertical">
                <div style="border-bottom: 2px solid #888; margin: 8px 0; padding: 4px 0;">alerter</div>

                <div class="center horizontal justified layout" style="padding: 8px 0;">
                    <div style="color: #757575;">enable GCM</div>
                    <paper-toggle-button checked disabled></paper-toggle-button>
                </div>

                <div class="center horizontal justified layout" style="padding: 8px 0;">
                    <div style="color: #757575;">enable email alert</div>
                    <paper-toggle-button disabled></paper-toggle-button>
                </div>

                <div style="border-bottom: 2px solid #888; margin: 8px 0; padding: 4px 0;">scheduler</div>

                <div class="center horizontal justified layout">
                    <div style="color: #757575;">schedule / day</div>
                    <paper-slider disabled editable id="seeds" max="96" min="1" style="width: 100px;" value="4"></paper-slider>
                </div>

                <div style="border-bottom: 2px solid #888; margin: 8px 0; padding: 4px 0;">user: <span>{{user.name}}</span></div>

                <div class="center horizontal justified layout" style="padding: 8px 0;">
                    <div>enable proxy</div>
                    <paper-toggle-button checked="{{proxy}}"></paper-toggle-button>
                </div>

                <div class="end-justified horizontal layout">
                    <paper-button class="blue-500" on-click="sign_out" style="margin: 8px 0; width: 50%;">SIGN OUT</paper-button>
                </div>
            </div>
        </paper-dialog>

        <paper-dialog id="remove_prompt" on-iron-overlay-closed="prompt_closed" style="width: 320px;" with-backdrop>
            <div>Are you sure to delete this item ?</div>

            <div class="buttons">
                <paper-button onclick="document.querySelector('#remove_prompt').close();">
                    <iron-icon icon="close"></iron-icon>
                    cancel
                </paper-button>
                <paper-button on-click="remove_ok">
                    <iron-icon icon="check"></iron-icon>
                    ok
                </paper-button>
            </div>
        </paper-dialog>

        <paper-dialog id="schedule_prompt" on-iron-overlay-closed="prompt_closed" style="width: 320px;" with-backdrop>
            <div>Are you sure to schedule this item ?</div>

            <div class="buttons">
                <paper-button onclick="document.querySelector('#schedule_prompt').close();">
                    <iron-icon icon="close"></iron-icon>
                    cancel
                </paper-button>
                <paper-button on-click="schedule_ok">
                    <iron-icon icon="check"></iron-icon>
                    ok
                </paper-button>
            </div>
        </paper-dialog>

        <modal-wrapper id="torrent_prompt">
            <div class="center-center fit horizontal layout" on-click="torrent_prompt_close" style="background: rgba(0, 0, 0, 0.5); padding: 24px; padding-bottom: 48px; z-index: 1;">
                <div class="layout vertical" style="height: 100%; width: 320px;">
                    <div class="flex white" style="overflow: auto; padding: 24px;">
                        <iron-selector activate-event="click" id="link" on-click="link" selected-attribute="selected">
                            <template is="dom-repeat" items="[[torrent_prompt.link]]">
                                <div class="cursor-p horizontal justified layout menu-li" data-link$="[[item.url]]">
                                    <div style="padding: 16px; padding-right: 8px;">
                                        <selectable-icon icon_class$="[[return_class(item.text)]]" icon_text$="[[return_icon_text(item.text)]]"></selectable-icon>
                                    </div>

                                    <div class="flex layout vertical" style="padding: 16px; padding-left: 8px;">
                                        <div class="etc" style="font-size: 16px; line-height: 24px;">[[item.text]]</div>
                                        <div class="etc" style="color: #757575; font-size: 14px; line-height: 20px;">[[return_time(item.time)]]</div>
                                    </div>
                                </div>
                            </template>
                        </iron-selector>
                    </div>

                    <div class="cursor-p layout vertical" style="background: #EEE; padding: 24px;">
                        <div style="color: #757575; font-size: 14px; line-height: 20px;">[[return_torrent_description(torrent_prompt)]]</div>

                        <div><span style="font-size: 16px; line-height: 24px;">[[torrent_prompt.title]]</span>&nbsp;&nbsp;<span class$="[[return_class(torrent_prompt.category)]]" style="font-size: 14px; line-height: 20px; padding-left: 4px; padding-right: 4px;">[[torrent_prompt.category]]</span>&nbsp;&nbsp;</div>
                    </div>
                </div>
            </div>
        </modal-wrapper>
    </template>

    <script>
    Polymer({

        add_project: function() {
            FlowRouter.setQueryParams({
                "route": "add-project"
            });
        },

        attached: function() {
            var _this = this;

            Tracker.autorun(function() {
                _this.user = (Meteor.user() ? Meteor.user() : {});
            });

            if ((document.querySelector("#torrent_db").value || []).length) {
                _this.project = document.querySelector("#torrent_db").value;
            }

            Meteor.setTimeout(function() {
                _project.find().observe({
                    added: function(row) {
                        var item = _.find(_this.project, function(A) {
                            return (row._id === A._id);
                        });

                        if (!item) {
                            for (var A = 0; A < row.torrent.length; A++) {
                                var item = _torrent.findOne({
                                    _id: row.torrent[A]
                                });

                                row.torrent[A] = (item ? item : {
                                    _id: row.torrent[A]
                                });

                                row.torrent[A].project = {
                                    _id: row._id
                                };
                            }

                            _this.project.unshift(row);

                            _this.project = _.clone(_this.project);
                        }
                    },

                    changed: function(row, old) {
                        var index = _.map(_this.project, function(A) {
                            return A._id;
                        }).indexOf(row._id);

                        if (-1 < index) {
                            for (var A = 0; A < row.torrent.length; A++) {
                                var item = _torrent.findOne({
                                    _id: row.torrent[A]
                                });

                                row.torrent[A] = (item ? item : {
                                    _id: row.torrent[A]
                                });

                                row.torrent[A].project = {
                                    _id: row._id
                                };
                            }

                            _this.project[index] = _.clone($.extend(true, _this.project[index], row));

                            _this.project[index] = _.clone(_this.project[index]);
                            _this.project = _.clone(_this.project);
                        }
                    },

                    removed: function(old) {
                        var index = _.map(_this.project, function(A) {
                            return A._id;
                        }).indexOf(old._id);

                        if (-1 < index) {
                            _this.project.splice(index, 1);

                            _this.project = _.clone(_this.project);
                        }
                    }
                });
            }, 1000);

            Meteor.setTimeout(function() {
                _torrent.find().observe({
                    added: function(row) {
                        for (var A = 0; A < _this.project.length; A++) {
                            var index = _.map(_this.project[A].torrent, function(item) {
                                return item._id;
                            }).indexOf(row._id);

                            if (-1 < index) {
                                _this.project[A].torrent[index] = _.clone($.extend(true, _this.project[A].torrent[index], row));

                                _this.project[A].torrent = _.clone(_this.project[A].torrent);
                                _this.project[A] = _.clone(_this.project[A]);
                                _this.project = _.clone(_this.project);
                            }
                        }
                    },

                    changed: function(row, old) {
                        for (var A = 0; A < _this.project.length; A++) {
                            var index = _.map(_this.project[A].torrent, function(item) {
                                return item._id;
                            }).indexOf(row._id);

                            if (-1 < index) {
                                _this.project[A].torrent[index] = _.clone($.extend(true, _this.project[A].torrent[index], row));

                                _this.project[A].torrent = _.clone(_this.project[A].torrent);
                                _this.project[A] = _.clone(_this.project[A]);
                                _this.project = _.clone(_this.project);
                            }
                        }
                    },

                    removed: function(old) {
                        for (var A = 0; A < _this.project.length; A++) {
                            var index = _.map(_this.project[A].torrent, function(item) {
                                return item._id;
                            }).indexOf(old._id);

                            if (-1 < index) {
                                _this.project[A].torrent.splice(index, 1);

                                _this.project[A].torrent = _.clone(_this.project[A].torrent);
                                _this.project[A] = _.clone(_this.project[A]);
                                _this.project = _.clone(_this.project);
                            }
                        }
                    }
                });
            }, 1000);

            if (Meteor.isCordova) {
                _splash.release();
            }
        },

        clear_torrent_selection: function() {
            this.torrent_selected = [];
        },

        initialize_proxy: function() {
            this.proxy = false;
        },

        is_search: function(worker) {
            return (worker == "search")
        },

        is: "layout-inbox",

        link: function(e) {
            e.stopPropagation();

            this.async(function() {
                window.open((this.proxy ? "http://proxy.vcompile.com/index.php?url=" + encodeURIComponent(document.querySelector("#link").selectedItem.dataset.link) : document.querySelector("#link").selectedItem.dataset.link), "_system");
            }, 200);
        },

        menuToggle: function() {
            if (this.$.drawer.narrow && $(this.$.drawer).width() <= parseInt(this.$.drawer.responsiveWidth)) {
                this.$.drawer.togglePanel();
            } else {
                this.$.drawer.forceNarrow = !this.$.drawer.forceNarrow;
            }
        },

        menu_opt: function(e, d) {
            this.menuToggle();

            this.$.main_toolbar.className = this.$.main_toolbar.className.replace(/ ?[a-z\-]+\-500/g, "") + " " + document.querySelector("#menu_opt .iron-selected selectable-icon").icon_class;

            this.menu_selected = d.item.dataset.id;
        },

        observers: [
            "project_change(project.splices)",
            "torrent_selected_change(torrent_selected.splices)"
        ],

        project_change: function(change) {
            this.$.main_page.selected = (this.project.length ? 1 : 0);
        },

        project_selected: function(menu_opt, project_opt) {
            return (menu_opt == "" ? true : menu_opt == project_opt);
        },

        prompt_closed: function() {
            FlowRouter.setQueryParams({
                "route": null
            });
        },

        properties: {
            menu_selected: {
                type: String,
                value: ""
            },
            project: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            proxy: {
                type: Boolean,
                value: false
            },
            torrent_prompt: {
                type: Object,
                value: function() {
                    return {};
                }
            },
            torrent_selected: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            user: {
                type: Object,
                value: function() {
                    return {};
                }
            }
        },

        refresh: function(e) {
            if (Meteor.status().connected) {
                var _this = this;

                Meteor.call("refresh", Polymer.dom(e).localTarget.dataset.id, function(error, response) {
                    if (error) {
                        document.querySelector("#polymer_toast").toast(error.reason);
                    } else {
                        var index = _.map(_this.project, function(A) {
                            return A._id;
                        }).indexOf(response._id);

                        if (-1 < index) {
                            for (var A = 0; A < response.torrent.length; A++) {
                                var item = _torrent.findOne({
                                    _id: response.torrent[A]
                                });

                                response.torrent[A] = (item ? item : {
                                    _id: response.torrent[A]
                                });

                                response.torrent[A].project = {
                                    _id: response._id
                                };
                            }

                            _this.project[index] = response;

                            _this.project[index] = _.clone(_this.project[index]);
                            _this.project = _.clone(_this.project);
                        }
                    }
                });
            } else {
                document.querySelector("#polymer_toast").toast("server connection required");
            }
        },

        remove_ok: function(e) {
            if (Meteor.status().connected) {
                var _this = this;

                Meteor.call("remove_project", _this.$.remove_prompt.dataset.id, function(error, response) {
                    if (error) {
                        document.querySelector("#polymer_toast").toast(error.reason);
                    } else {
                        document.querySelector("#polymer_toast").toast(response);

                        _this.$.main_toolbar.className = _this.$.main_toolbar.className.replace(/ ?[a-z\-]+\-500/g, "");

                        _this.menu_selected = "";
                    }
                });
            } else {
                document.querySelector("#polymer_toast").toast("server connection required");
            }

            this.$.remove_prompt.close();
        },

        remove_project: function(e) {
            this.$.remove_prompt.dataset.id = Polymer.dom(e).localTarget.dataset.id;

            FlowRouter.setQueryParams({
                "route": "remove-prompt"
            });
        },

        remove_torrent: function() {
            $("inbox-item.iron-selected").addClass("undo");

            document.querySelector("#polymer_toast").undo = {
                torrent: _.map(this.torrent_selected, function(A) {
                    return A._id;
                })
            };

            document.querySelector("#polymer_toast").toast(this.torrent_selected.length + " torrent removed");

            this.clear_torrent_selection();
        },

        return_class: function(text) {
            return polymer_color(text ? text : "#");
        },

        return_project_description: function(item) {
            return (item.worker == "schedule" ? item.within + "M | " + item.leech + "L / " + item.seed + "S" : moment(item.time).format("MMM DD ddd hh:mm A"));
        },

        return_icon_text: function(text) {
            return (isNaN(text.charAt(0)) ? text.charAt(0) : "#");
        },

        return_text: function(text) {
            return (text ? text : "#");
        },

        return_time: function(time) {
            return moment(time).fromNow();
        },

        return_torrent_count: function(torrent) {
            var A = _.countBy(torrent, function(item) {
                return item.url ? "YES" : "NO";
            });

            return (A.YES && A.NO ? A.YES + " / " : "") + torrent.length;
        },

        return_torrent_description: function(item) {
            return (item.size ? item.size : "#") + " | " + (item.leech ? item.leech + "L" : "#") + " / " + (item.seed ? item.seed + "S" : "#");
        },

        schedule: function(e) {
            this.$.schedule_prompt.dataset.id = Polymer.dom(e).localTarget.dataset.id;

            FlowRouter.setQueryParams({
                "route": "schedule-prompt"
            });
        },

        schedule_ok: function(e) {
            if (Meteor.status().connected) {
                var _this = this;

                Meteor.call("schedule_project", _this.$.schedule_prompt.dataset.id, function(error, response) {
                    if (error) {
                        document.querySelector("#polymer_toast").toast(error.reason);
                    } else {
                        document.querySelector("#polymer_toast").toast(response);

                        _this.$.main_toolbar.className = _this.$.main_toolbar.className.replace(/ ?[a-z\-]+\-500/g, "");

                        _this.menu_selected = "";
                    }
                });
            } else {
                document.querySelector("#polymer_toast").toast("server connection required");
            }

            this.$.schedule_prompt.close();
        },

        search_bar: function() {
            FlowRouter.setQueryParams({
                "route": "search-bar"
            });
        },

        share: function() {
            var body = "";

            for (var A = 0; A < this.torrent_selected.length; A++) {
                if (this.torrent_selected[A].link.length) {
                    body += "\n\n" + (A + 1) + "\t\t" + this.torrent_selected[A].title + "\n\n";

                    this.torrent_selected[A].link = _.sortBy(this.torrent_selected[A].link, "time");

                    for (var Z = 0; Z < this.torrent_selected[A].link.length; Z++) {
                        body += "\t\t" + (Z + 1) + "\t\t" + this.torrent_selected[A].link[Z].url + "\n\n";
                    }
                }
            }

            if (body != "") {
                if (Meteor.isCordova) {
                    window.plugins.socialsharing.share("Hi\n\nTorrentAlert - " + this.user.profile.name + " shared " + this.torrent_selected.length + " torrent" + body);
                } else {
                    window.open("mailto:" + this.user.profile.email + "?subject=" + encodeURIComponent("TorrentAlert") + "&body=" + encodeURIComponent("Hi\n\n" + this.user.profile.name + " shared " + this.torrent_selected.length + " torrent" + body), "_system");
                }
            } else {
                document.querySelector("#polymer_toast").toast("empty email body");
            }
        },

        sign_out: function() {
            if (Meteor.status().connected) {
                this.project = [];

                FlowRouter.go("/inbox/sign-out");
            } else {
                document.querySelector("#polymer_toast").toast("server connection required");
            }
        },

        sort: function(e) {
            var A = Polymer.dom(e).localTarget.dataset.index;

            this.project[A].torrent = _.sortBy(this.project[A].torrent, "time").reverse();
            this.project[A] = _.clone(this.project[A]);
            this.project = _.clone(this.project);
        },

        torrent_prompt_close: function() {
            FlowRouter.setQueryParams({
                "route": null
            });
        },

        torrent_prompt_open: function(item) {
            if (_.has(item, "link") && item.link.length) {
                this.torrent_prompt = item;

                FlowRouter.setQueryParams({
                    "route": "torrent-prompt"
                });
            } else {
                document.querySelector("#polymer_toast").toast("under processing");
            }
        },

        torrent_selected_change: function(change) {
            this.$.main_toolbar_title.textContent = (this.torrent_selected.length ? this.torrent_selected.length : "TorrentAlert");

            this.$.main_toolbar.toggleClass("grey-500", this.torrent_selected.length);
            this.$.main_toolbar.toggleClass("selection", this.torrent_selected.length);

            this.$.fab.toggleClass("move-down", this.torrent_selected.length);
        },

        user_prompt: function() {
            FlowRouter.setQueryParams({
                "route": "user-prompt"
            });
        }

    });
    </script>

</dom-module>
