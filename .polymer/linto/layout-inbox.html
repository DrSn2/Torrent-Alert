<dom-module id="layout-inbox">

  <style>
  paper-dialog {
    width: 320px;
  }
  
  paper-drawer-panel /deep/ #drawer,
  paper-drawer-panel /deep/ #main #scrim {
    z-index: 1;
  }
  
  paper-fab {
    --paper-fab-background: var(--paper-red-500);
    --paper-fab-keyboard-focus-background: var(--paper-red-700);
  }
  
  paper-progress {
    width: 100%;
  }
  
  paper-toolbar {
    --paper-toolbar-background: var(--paper-cyan-700);
    --paper-toolbar-color: white;
  }
  
  paper-toolbar paper-icon-button {
    margin: 0!important;
  }
  
  paper-toolbar paper-icon-button[icon="arrow-back"] {
    transform: translateX(-42px);
  }
  
  paper-toolbar.selection paper-icon-button[icon="arrow-back"] {
    transform: translateX(0);
  }
  
  paper-toolbar.selection .selection-hidden {
    display: none;
  }
  
  paper-toolbar.selection .selection-visible {
    padding: 8px;
    transform: rotateX(0);
    visibility: visible;
    width: 40px;
  }
  
  paper-toolbar .selection-visible {
    padding: 0;
    transform: rotateX(90deg);
    transition: transform 400ms ease-in-out;
    visibility: hidden;
    width: 0;
    will-change: transform;
  }
  
  paper-toolbar .title {
    padding: 0 12px;
  }
  
  .body1 {
    @apply(--paper-font-body1);
    color: #757575;
  }
  
  .footer-li {
    min-height: 88px;
  }
  
  .menu-li {
    border-bottom: 1px solid #EEE;
    padding: 8px;
  }
  /*.menu-li-bottom {
    border-top: 1px solid #EEE;
    padding: 8px;
    z-index: 1;
  }*/
  
  .menu-li > div,
  /*.menu-li-bottom > div,*/
  
  .title-li,
  .title-li > div {
    padding: 8px;
  }
  
  .menu-b {
    bottom: 16px;
    position: fixed;
    right: 16px;
    transition: transform 0.2s ease-in-out;
    will-change: transform;
  }
  
  .menu-b.move-down {
    transform: translate3d(0, 88px, 0)!important;
  }
  
  .subhead {
    @apply(--paper-font-subhead);
  }
  
  .trend-li {
    padding: 4px 12px;
  }
  
  .trend-li > div {
    margin: 4px;
    padding: 4px 12px;
  }
  
  .undo {
    display: none!important;
  }
  </style>

  <template>
    <iron-localstorage name="trend" on-iron-localstorage-load-empty="initialize_trend" value="{{trend}}"></iron-localstorage>

    <paper-drawer-panel id="drawer">
      <paper-header-panel drawer>
        <div class="fit layout vertical">
          <template if="[[user._id]]" is="dom-if">
            <paper-icon-item class="cursor-p" id="user-li">
              <selectable-icon icon_img_src="[[user.profile.picture]]" item-icon></selectable-icon>

              <paper-item-body two-line>
                <div>[[user.profile.name]]</div>
                <div secondary>[[user.profile.email]]</div>
              </paper-item-body>

              <div class="subhead">[[return_text(project.length)]]</div>
            </paper-icon-item>

            <!-- <div class="cursor-p horizontal hover layout menu-li relative" on-click="user_prompt">
              <div>
                <selectable-icon icon_img_src="[[user.profile.picture]]"></selectable-icon>
              </div>

              <div class="flex layout vertical">
                <div class="horizontal layout">
                  <div class="etc flex self-center subhead">[[user.profile.name]]</div>
                  <div class="body1 self-start">[[return_text(project.length)]]</div>
                </div>

                <div class="body1 etc">[[user.profile.email]]</div>
              </div>

              <paper-ripple></paper-ripple>
            </div> -->
          </template>

          <div class="flex" style="overflow: auto;">
            <iron-selector id="menu_opt" on-iron-activate="menu_opt" selected-attribute="selected">
              <div class="cursor-p horizontal hover layout menu-li relative" data-id="trend">
                <div>
                  <selectable-icon icon_class="cyan-700" icon_text="@"></selectable-icon>
                </div>

                <div class="flex layout vertical">
                  <div class="horizontal layout">
                    <div class="etc flex self-center subhead">Trending</div>
                    <div class="body1 self-start">[[return_text(trend.keyword.length)]]</div>
                  </div>

                  <div class="body1 etc">[[return_time(trend.time)]]</div>
                </div>

                <paper-ripple></paper-ripple>
              </div>

              <template is="dom-repeat" items="[[project]]">
                <div class="cursor-p horizontal hover layout menu-li relative" data-id$="[[item._id]]" data-keyword$="[[item.keyword]]">
                  <div>
                    <selectable-icon icon_class="[[return_class(item.keyword)]]" icon_text="[[return_icon_text(item.keyword)]]"></selectable-icon>
                  </div>

                  <div class="flex layout vertical">
                    <div class="horizontal layout">
                      <div class="etc flex self-center subhead">[[item.keyword]]</div>
                      <div class="body1 self-start">[[return_torrent_count(item.torrent)]]</div>
                    </div>

                    <div class="body1 etc">[[return_project_description(item)]]</div>
                  </div>

                  <paper-ripple></paper-ripple>
                </div>
              </template>
            </iron-selector>
          </div>

          <paper-item class="cursor-p" style="border-top: 1px solid #EEE;" onclick="window.open('https://github.com/HedCET/TorrentAlert', '_system')">About TorrentAlert</paper-item>

          <!-- <div class="cursor-p center center-justified horizontal layout menu-li-bottom relative subhead white" onclick="window.open('https://github.com/HedCET/TorrentAlert', '_system')">
            <div>About TorrentAlert</div>

            <paper-ripple></paper-ripple>
          </div> -->
        </div>
      </paper-header-panel>

      <paper-header-panel main>
        <paper-toolbar id="main_toolbar">
          <paper-icon-button class="selection-visible" icon="arrow-back" on-click="clear_torrent_selection"></paper-icon-button>
          <paper-icon-button class="selection-hidden" icon="menu" paper-drawer-toggle></paper-icon-button>

          <div class="title" id="main_toolbar_title">TorrentAlert</div>

          <paper-icon-button class="selection-visible" icon="delete" on-click="remove_torrent"></paper-icon-button>
          <paper-icon-button class="selection-visible" icon="social:share" on-click="share"></paper-icon-button>
          <paper-icon-button class="selection-hidden" icon="search" on-click="search_bar"></paper-icon-button>
        </paper-toolbar>

        <neon-animated-pages class="fit" id="main_page" selected="1">
          <neon-animatable>
            <paper-header-panel>
              <div class="center-justified horizontal layout">
                <div class="li">
                  <div class="center cursor-d horizontal layout title-li">
                    <div>
                      <iron-icon icon="store"></iron-icon>
                    </div>

                    <div class="subhead" style="border-bottom: 1px solid #757575;">Trending Top [[return_text(trend.keyword.length)]]</div>
                  </div>
                </div>
              </div>

              <div class="center-justified horizontal layout">
                <div class="li">
                  <div class="horizontal layout trend-li wrap">
                    <template is="dom-repeat" items="[[trend.keyword]]">
                      <div class="cursor-p grey-500 subhead" on-click="trend_opt">[[item]]</div>
                    </template>
                  </div>
                </div>
              </div>

              <div class="footer-li"></div>
            </paper-header-panel>
          </neon-animatable>

          <neon-animatable>
            <iron-selector attr-for-selected="item" multi selectable="inbox-item" selected-attribute="selected" selected-values="{{torrent_selected}}">
              <template is="dom-repeat" items="[[project]]">
                <template if="[[project_selected(menu_selected, item._id)]]" is="dom-if">
                  <div class="center-justified horizontal layout">
                    <div class="li">
                      <div class="center horizontal layout title-li">
                        <div class="flex subhead">[[item.keyword]]</div>

                        <paper-icon-button data-id$="[[item._id]]" icon="refresh" on-click="refresh"></paper-icon-button>
                        <paper-icon-button data-id$="[[item._id]]" icon="alarm-add" hidden="[[!is_search(item.worker)]]" on-click="schedule"></paper-icon-button>
                        <paper-icon-button data-id$="[[item._id]]" icon="close" on-click="remove_project"></paper-icon-button>
                      </div>
                    </div>
                  </div>

                  <div class="center-justified horizontal layout">
                    <div class="li">
                      <paper-progress class="project_progress" data-id$="[[item._id]]" hidden></paper-progress>
                    </div>
                  </div>

                  <template as="torrent" filter="filter_url" is="dom-repeat" items="[[item.torrent]]" sort="sort">
                    <inbox-item item="[[torrent]]"></inbox-item>
                  </template>
                </template>
              </template>
            </iron-selector>

            <div class="footer-li"></div>
          </neon-animatable>
        </neon-animated-pages>
      </paper-header-panel>
    </paper-drawer-panel>

    <paper-fab class="menu-b" id="fab" icon="add" on-click="add_project"></paper-fab>

    <paper-dialog id="remove_prompt" with-backdrop>
      <div class="subhead">Are you sure to delete this item ?</div>

      <div class="buttons">
        <paper-button onclick="document.querySelector('#remove_prompt').close();">
          <iron-icon icon="close"></iron-icon>cancel
        </paper-button>
        <paper-button on-click="remove_ok">
          <iron-icon icon="check"></iron-icon>ok
        </paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="schedule_prompt" with-backdrop>
      <div class="subhead">Are you sure to schedule this item ?</div>

      <div class="buttons">
        <paper-button onclick="document.querySelector('#schedule_prompt').close();">
          <iron-icon icon="close"></iron-icon>cancel
        </paper-button>
        <paper-button on-click="schedule_ok">
          <iron-icon icon="check"></iron-icon>ok
        </paper-button>
      </div>
    </paper-dialog>
  </template>

  <script>
  Polymer({

    add_project: function() {
      FlowRouter.setQueryParams({
        "route": "add-project"
      });
    },

    attached: function() {
      if ((document.querySelector("#torrent_db").value || []).length) {
        this.project = document.querySelector("#torrent_db").value;
      }

      var _this = this;

      Tracker.autorun(function() {
        _this.user = (Meteor.user() ? Meteor.user() : {});
      });

      Meteor.setTimeout(function() {
        if (6 < moment.duration(moment().diff(moment(_this.trend.time))).asHours() || !_this.trend.keyword.length) {
          Meteor.call("trend", function(error, response) {
            if (error) {
              document.querySelector("#polymer_toast").toast(error.reason);
            } else {
              if (response.length) {
                _this.trend = {
                  keyword: response,
                  time: moment().format()
                };
              }
            }
          });
        }
      }, 1000);

      Meteor.setTimeout(function() {
        _project.find().observe({
          added: function() {
            _this._updater();
          },

          changed: function() {
            _this._updater();
          },

          removed: function(row) {
            var index = _.map(_this.project, function(A) {
              return A._id;
            }).indexOf(row._id);

            if (-1 < index) {
              _this.splice("project", index, 1);
            }
          }
        });
      }, 1000);

      Meteor.setTimeout(function() {
        _torrent.find().observe({
          added: function() {
            _this._updater();
          },

          changed: function(row) {
            _this._updater();
          },

          removed: function(row) {
            for (var A = 0; A < _this.project.length; A++) {
              var index = _.map(_this.project[A].torrent, function(item) {
                return item._id;
              }).indexOf(row._id);

              if (-1 < index) {
                _this.splice("project." + A + ".torrent", index, 1);
              }
            }
          }
        });
      }, 1000);
    },

    clear_torrent_selection: function() {
      this.torrent_selected = [];
    },

    filter_url: function(torrent) {
      return (torrent.url);
    },

    initialize_trend: function() {
      this.trend = {
        keyword: [],
        time: moment().format()
      };
    },

    is: "layout-inbox",

    is_search: function(worker) {
      return (worker == "search")
    },

    menu_opt: function(e, d) {
      this.$.drawer.closeDrawer();

      this.$.main_toolbar.className = this.$.main_toolbar.className.replace(/ ?[a-z\-]+\-500/g, "") + (d.item.dataset.id == "trend" ? "" : " " + polymer_color(d.item.dataset.keyword));

      this.$.main_page.selected = (d.item.dataset.id == "trend" ? 0 : 1);

      this.menu_selected = d.item.dataset.id;
    },

    observers: [
      "project_change(project.splices)",
      "torrent_selected_change(torrent_selected.splices)"
    ],

    project_change: function(change) {
      this.debounce("project_change", function() {
        if (this.menu_selected != "trend") {
          this.$.main_page.selected = (this.project.length ? 1 : 0);
        }
      }, 1000);
    },

    project_selected: function(menu_opt, project_opt) {
      return (menu_opt == "" ? true : menu_opt == project_opt);
    },

    properties: {
      menu_selected: {
        type: String,
        value: ""
      },
      project: {
        type: Array,
        value: function() {
          return [];
        }
      },
      torrent_selected: {
        type: Array,
        value: function() {
          return [];
        }
      },
      trend: {
        type: Object,
        value: function() {
          return {
            keyword: [],
            time: moment().format()
          };
        }
      },
      user: {
        type: Object,
        value: function() {
          return {};
        }
      }
    },

    refresh: function(e) {
      if (Meteor.status().connected) {

        var _this = this,
          project_id = Polymer.dom(e).localTarget.dataset.id;

        if (document.querySelector('.project_progress[data-id="' + project_id + '"]')) {
          var project_progress = document.querySelector('.project_progress[data-id="' + project_id + '"]');

          project_progress.hidden = false;

          project_progress.max = 50;
          project_progress.value = 10;
        }

        Meteor.call("refresh", project_id, function(error, response) {
          if (error) {
            document.querySelector("#polymer_toast").toast(error.reason);
          } else {
            var index = _.map(_this.project, function(A) {
              return A._id;
            }).indexOf(response._id);

            if (-1 < index) {
              for (var A = 0; A < response.torrent.length; A++) {
                var item = _torrent.findOne({
                  _id: response.torrent[A]
                });

                response.torrent[A] = (item ? item : {
                  _id: response.torrent[A]
                });

                response.torrent[A].project = {
                  _id: response._id
                };
              }

              _this.splice("project", index, 1, response);
            }
          }
        });
      } else {
        document.querySelector("#polymer_toast").toast("server connection required");
      }
    },

    remove_ok: function(e) {
      if (Meteor.status().connected) {
        var _this = this;

        Meteor.call("remove_project", _this.$.remove_prompt.dataset.id, function(error, response) {
          if (error) {
            document.querySelector("#polymer_toast").toast(error.reason);
          } else {
            document.querySelector("#polymer_toast").toast(response);

            _this.menu_selected = "";

            _this.$.main_toolbar.className = _this.$.main_toolbar.className.replace(/ ?[a-z\-]+\-500/g, "");
          }
        });
      } else {
        document.querySelector("#polymer_toast").toast("server connection required");
      }

      this.$.remove_prompt.close();
    },

    remove_project: function(e) {
      this.$.remove_prompt.dataset.id = Polymer.dom(e).localTarget.dataset.id;
      this.$.remove_prompt.open();
    },

    remove_torrent: function() {
      $("inbox-item.iron-selected").addClass("undo");

      document.querySelector("#polymer_toast").undo = {
        torrent: _.map(this.torrent_selected, function(A) {
          return A._id;
        })
      };

      document.querySelector("#polymer_toast").toast(this.torrent_selected.length + " torrent removed");

      this.clear_torrent_selection();
    },

    return_class: function(text) {
      return polymer_color(text ? text : "#");
    },

    return_icon_text: function(text) {
      return (isNaN(text.charAt(0)) ? text.charAt(0) : "#");
    },

    return_project_description: function(item) {
      return (item.worker == "schedule" ? item.within + "M | " + item.leech + "L / " + item.seed + "S" : moment(item.time).format("MMM DD ddd hh:mm A"));
    },

    return_text: function(text) {
      return (text ? text : "#");
    },

    return_time: function(time) {
      return (moment(time).isValid() ? moment(time).format("MMM DD ddd hh:mm A") : "#");
    },

    return_torrent_count: function(torrent) {
      var A = _.countBy(torrent, function(item) {
        return item.url ? "YES" : "NO";
      });

      return (A.YES && A.NO ? A.YES + " / " : "") + (torrent.length ? torrent.length : "#");
    },

    return_torrent_description: function(item) {
      return (item.size ? item.size : "#") + " | " + (item.leech ? item.leech + "L" : "#") + " / " + (item.seed ? item.seed + "S" : "#");
    },

    schedule: function(e) {
      this.$.schedule_prompt.dataset.id = Polymer.dom(e).localTarget.dataset.id;
      this.$.schedule_prompt.open();
    },

    schedule_ok: function(e) {
      if (Meteor.status().connected) {
        var _this = this;

        Meteor.call("schedule_project", _this.$.schedule_prompt.dataset.id, function(error, response) {
          if (error) {
            document.querySelector("#polymer_toast").toast(error.reason);
          } else {
            document.querySelector("#polymer_toast").toast(response);

            _this.menu_selected = "";

            _this.$.main_toolbar.className = _this.$.main_toolbar.className.replace(/ ?[a-z\-]+\-500/g, "");
          }
        });
      } else {
        document.querySelector("#polymer_toast").toast("server connection required");
      }

      this.$.schedule_prompt.close();
    },

    search_bar: function() {
      FlowRouter.setQueryParams({
        "route": "search-bar"
      });
    },

    share: function() {
      var body = "";

      for (var A = 0; A < this.torrent_selected.length; A++) {
        if (this.torrent_selected[A].link.length) {
          body += "\n\n" + (A + 1) + "\t\t" + this.torrent_selected[A].title + "\n\n";

          for (var Z = 0; Z < this.torrent_selected[A].link.length; Z++) {
            body += "\t\t" + (Z + 1) + "\t\t" + this.torrent_selected[A].link[Z].url + "\n\n";
          }
        }
      }

      if (body != "") {
        if (Meteor.isCordova) {
          window.plugins.socialsharing.share("Hi\n\nTorrentAlert - " + this.user.profile.name + " shared " + this.torrent_selected.length + " torrent" + body);
        } else {
          window.open("mailto:" + this.user.profile.email + "?subject=" + encodeURIComponent("TorrentAlert") + "&body=" + encodeURIComponent("Hi\n\n" + this.user.profile.name + " shared " + this.torrent_selected.length + " torrent" + body), "_system");
        }
      } else {
        document.querySelector("#polymer_toast").toast("empty email body");
      }
    },

    // sign_out: function() {
    //   if (Meteor.status().connected) {
    //     this.project = [];

    //     FlowRouter.go("/inbox/sign-out");
    //   } else {
    //     document.querySelector("#polymer_toast").toast("server connection required");
    //   }
    // },

    sort: function(A, Z) {
      return (parseInt(moment(Z.time).format("x")) - parseInt(moment(A.time).format("x")));
    },

    torrent_selected_change: function(change) {
      this.$.main_toolbar_title.textContent = (this.torrent_selected.length ? this.torrent_selected.length : "TorrentAlert");

      this.$.main_toolbar.toggleClass("grey-500", this.torrent_selected.length);
      this.$.main_toolbar.toggleClass("selection", this.torrent_selected.length);

      this.$.fab.toggleClass("move-down", this.torrent_selected.length);
    },

    trend_opt: function(e) {
      if (Meteor.status().connected) {
        var keyword = Polymer.dom(e).localTarget.textContent.trim();

        if (keyword.length) {
          var _this = this,
            row = {
              keyword: keyword,
              leech: 1,
              seed: 1,
              url: "search",
              within: 6,
              worker: "search"
            };

          Meteor.call("insert_project", row, function(error, response) {
            if (error) {
              document.querySelector("#polymer_toast").toast((error.reason == "userNotFound") ? "internet/user required" : error.reason);
            } else {
              if (response == "") {
                document.querySelector("#polymer_toast").toast("unknown issue");
              } else {
                document.querySelector("#polymer_toast").toast("i keyword added");

                _this.$.main_toolbar.className = _this.$.main_toolbar.className.replace(/ ?[a-z\-]+\-500/g, "") + " " + polymer_color(keyword);

                _this.menu_selected = response;

                Meteor.setTimeout(function() {
                  if (document.querySelector('.project_progress[data-id="' + response + '"]')) {
                    var project_progress = document.querySelector('.project_progress[data-id="' + response + '"]');

                    project_progress.hidden = false;

                    project_progress.max = 50;
                    project_progress.value = 10;
                  }
                }, 1000);
              }
            }
          });

          _this.$.main_page.selected = 1;
        } else {
          document.querySelector("#polymer_toast").toast("empty keyword");
        }
      } else {
        document.querySelector("#polymer_toast").toast("server connection required");
      }
    },

    // user_prompt: function() {
    //   this.$.user_prompt.open();
    // },

    _updater: function() {
      this.debounce("_updater", function() {
        var _this = this;

        _project.find().forEach(function(row) {
          for (var A = 0; A < row.torrent.length; A++) {
            var item = _torrent.findOne({
              _id: row.torrent[A]
            });

            row.torrent[A] = (item ? item : {
              _id: row.torrent[A]
            });

            row.torrent[A].project = {
              _id: row._id
            };
          }

          var index = _.map(_this.project, function(A) {
            return A._id;
          }).indexOf(row._id);

          if (-1 < index) {
            _this.set("project." + index, row);
          } else {
            _this.unshift("project", row);
          }
        });
      }, 1000);
    }

  });
  </script>

</dom-module>
