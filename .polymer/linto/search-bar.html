<dom-module id="search-bar">

  <style>
  :host {
    display: none;
  }
  
  :host([active]) {
    display: block;
  }
  
  paper-header-panel {
    background: rgba(255, 255, 255, 0.5);
    z-index: 10;
  }
  
  paper-progress {
    left: 0;
    position: fixed;
    width: 100%;
    z-index: 1;
    --paper-progress-active-color: var(--paper-red-500);
    --paper-progress-secondary-color: var(--paper-red-100);
  }
  
  paper-toolbar {
    --paper-toolbar-background: white;
    --paper-toolbar-color: black;
  }
  
  input {
    @apply(--paper-font-title);
    background: transparent;
    border: none;
    color: black;
    padding: 0 12px;
  }
  
  .footer-li {
    min-height: 88px;
  }
  
  .search-li {
    border-bottom: 1px solid #EEE;
    padding: 8px;
  }
  
  .search-li > div {
    padding: 8px;
  }
  
  .subhead {
    @apply(--paper-font-subhead);
  }
  </style>

  <template>
    <paper-header-panel class="fit">
      <paper-toolbar>
        <paper-icon-button icon="arrow-back" on-click="back"></paper-icon-button>
        <input autofocus bind-value="{{search_input}}" class="flex" is="iron-input" placeholder="search">
      </paper-toolbar>

      <paper-progress hidden id="progress" indeterminate></paper-progress>

      <template is="dom-repeat" items="[[list]]">
        <div class="center-justified horizontal layout">
          <div class="li">
            <div class="center cursor-p horizontal layout relative search-li white" on-click="add_project">
              <div>
                <iron-icon icon="launch"></iron-icon>
              </div>

              <div class="flex subhead">[[item]]</div>

              <paper-ripple></paper-ripple>
            </div>
          </div>
        </div>
      </template>

      <div class="footer-li"></div>
    </paper-header-panel>
  </template>

  <script>
  Polymer({

    add_project: function(e, d) {
      if (Meteor.status().connected) {
        var keyword = Polymer.dom(e).localTarget.textContent.trim();

        if (keyword.length) {
          var row = {
            keyword: keyword,
            leech: 1,
            seed: 1,
            url: "search",
            within: 6,
            worker: "search"
          };

          Meteor.call("insert_project", row, function(error, response) {
            if (error) {
              document.querySelector("#polymer_toast").toast((error.reason == "userNotFound") ? "internet/user required" : error.reason);
            } else {
              if (response == "") {
                document.querySelector("#polymer_toast").toast("unknown issue");
              } else {
                document.querySelector("#polymer_toast").toast("i keyword added");

                document.querySelector("#main_toolbar").className = document.querySelector("#main_toolbar").className.replace(/ ?[a-z\-]+\-500/g, "") + " " + polymer_color(keyword);

                document.querySelector("layout-inbox").menu_selected = response;

                Meteor.setTimeout(function() {
                  if (document.querySelector('.project_progress[data-id="' + response + '"]')) {
                    var project_progress = document.querySelector('.project_progress[data-id="' + response + '"]');

                    project_progress.hidden = false;

                    project_progress.max = 50;
                    project_progress.value = 10;
                  }
                }, 1000);
              }
            }
          });

          this.back();
        } else {
          document.querySelector("#polymer_toast").toast("empty keyword");
        }
      } else {
        document.querySelector("#polymer_toast").toast("server connection required");
      }
    },

    back: function() {
      FlowRouter.setQueryParams({
        "route": null
      });
    },

    is: "search-bar",

    properties: {
      active: {
        notify: true,
        reflectToAttribute: true,
        type: Boolean,
        value: false
      },
      list: {
        type: Array,
        value: function() {
          return [];
        }
      },
      search_input: {
        observer: "search",
        type: String,
        value: ""
      }
    },

    search: function(newValue, oldValue) {
      if (newValue && oldValue) {
        this.$.progress.hidden = false;

        // this.debounce("search", function() {
        if (this.search_input.trim().length) {
          if (Meteor.status().connected) {
            var _this = this;

            Meteor.call("search", _this.search_input.trim(), function(error, response) {
              _this.$.progress.hidden = true;

              if (!error) {
                _this.list = response;
              }
            });
          } else {
            document.querySelector("#polymer_toast").toast("server connection required");
          }
        } else {
          this.$.progress.hidden = true;
        }
        // }, 1000 * 4);
      }
    }

  });
  </script>

</dom-module>
